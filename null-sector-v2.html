<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NULL SECTOR</title>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg viewBox='0 0 64 64' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='64' height='64' fill='%23050510'/%3E%3Cpath d='M8 32 L32 8 L56 32 L32 56 Z' fill='none' stroke='%23ff00ff' stroke-width='2'/%3E%3Cpath d='M16 32 L32 16 L48 32 L32 48 Z' fill='none' stroke='%2300f3ff' stroke-width='2'/%3E%3Ccircle cx='32' cy='32' r='8' fill='none' stroke='%2339ff14' stroke-width='2'/%3E%3C/svg%3E">
    <style>
        :root {
            /* Muted, realistic CRT phosphor colors */
            --bg-deep: #030308;
            --bg-panel: #08080f;
            --bg-panel-alt: #0c0c16;
            --border-dark: #151525;
            --neon-pink: #c850c0;
            --neon-pink-dim: #8a3085;
            --neon-cyan: #4fc3dc;
            --neon-cyan-dim: #357f91;
            --neon-green: #32cd60;
            --neon-green-dim: #238544;
            --deep-purple: #4a1259;
            --warning-red: #d94455;
            --text-primary: #b8b8c8;
            --text-dim: #484860;
            --gold: #c9a227;
            /* Aliases for compatibility */
            --sol-purple: var(--neon-pink);
            --sol-purple-dim: var(--neon-pink-dim);
            --sol-green: var(--neon-cyan);
            --sol-green-dim: var(--neon-cyan-dim);
            --sol-cyan: var(--neon-green);
            --sol-cyan-dim: var(--neon-green-dim);
            /* CRT specific */
            --crt-glow: rgba(100, 180, 255, 0.03);
            --scanline-opacity: 0.08;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Share Tech Mono', monospace;
            background: var(--bg-deep);
            color: var(--text-primary);
            min-height: 100vh;
            font-size: 15px;
            line-height: 1.8;
            overflow-x: hidden;
            animation: crtFlicker 0.1s infinite;
        }

        @keyframes crtFlicker {
            0% { opacity: 0.98; }
            50% { opacity: 1; }
            100% { opacity: 0.985; }
        }

        /* CRT Scanlines - realistic horizontal lines */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 0, 0, var(--scanline-opacity)) 0px,
                rgba(0, 0, 0, var(--scanline-opacity)) 1px,
                transparent 1px,
                transparent 3px
            );
            z-index: 9998;
        }

        /* Vignette + subtle noise + screen glow */
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            background:
                /* Vignette - dark edges */
                radial-gradient(ellipse at center, transparent 0%, transparent 50%, rgba(0, 0, 0, 0.4) 100%),
                /* Subtle screen glow in center */
                radial-gradient(ellipse at center, var(--crt-glow) 0%, transparent 70%);
            z-index: 9997;
        }

        /* Noise overlay */
        .noise-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
            opacity: 0.03;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%' height='100%' filter='url(%23noise)'/%3E%3C/svg%3E");
        }

        /* Page scanner line */
        .page-scanline {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(200, 80, 192, 0.4), rgba(79, 195, 220, 0.4), transparent);
            animation: pageScan 8s linear infinite;
            pointer-events: none;
            z-index: 9996;
        }

        @keyframes pageScan {
            0% { top: 0; opacity: 0; }
            5% { opacity: 1; }
            95% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }

        /* Circuit Board Background - Hackers Style */
        .circuit-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
            background-color: var(--bg-deep);
            background-image:
                /* Main circuit traces - horizontal */
                linear-gradient(0deg,
                    transparent 0px, transparent 48px,
                    rgba(79, 195, 220, 0.025) 48px, rgba(79, 195, 220, 0.025) 50px,
                    transparent 50px),
                /* Main circuit traces - vertical */
                linear-gradient(90deg,
                    transparent 0px, transparent 48px,
                    rgba(79, 195, 220, 0.025) 48px, rgba(79, 195, 220, 0.025) 50px,
                    transparent 50px),
                /* Glow nodes at intersections */
                radial-gradient(circle at 50px 50px, rgba(79, 195, 220, 0.06) 0px, transparent 4px);
            background-size: 50px 50px, 50px 50px, 50px 50px;
        }

        /* Floating Data Cubes */
        .floating-cubes {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            overflow: hidden;
        }

        .data-cube {
            position: absolute;
            width: 60px;
            height: 60px;
            border: 1px solid rgba(79, 195, 220, 0.08);
            background: rgba(79, 195, 220, 0.015);
            transform: perspective(500px) rotateX(10deg) rotateY(-15deg);
            animation: cubeFloat 12s ease-in-out infinite;
        }

        .data-cube::before {
            display: none;
        }

        .data-cube::after {
            content: '';
            position: absolute;
            top: 5px;
            left: 5px;
            right: 5px;
            bottom: 5px;
            border: 1px solid rgba(79, 195, 220, 0.04);
        }

        @keyframes cubeFloat {
            0%, 100% { transform: perspective(500px) rotateX(10deg) rotateY(-15deg) translateY(0); }
            50% { transform: perspective(500px) rotateX(10deg) rotateY(-15deg) translateY(-8px); }
        }

        /* Cube positions and variations */
        .data-cube.cube-1 { top: 15%; left: 5%; width: 70px; height: 70px; opacity: 0.25; animation-delay: 0s; }
        .data-cube.cube-2 { top: 40%; left: 3%; width: 50px; height: 50px; opacity: 0.15; animation-delay: -2s; }
        .data-cube.cube-3 { top: 70%; left: 8%; width: 55px; height: 55px; opacity: 0.18; animation-delay: -4s; }
        .data-cube.cube-4 { top: 20%; right: 4%; width: 65px; height: 65px; opacity: 0.22; animation-delay: -1s; }
        .data-cube.cube-5 { top: 55%; right: 6%; width: 45px; height: 45px; opacity: 0.15; animation-delay: -3s; }
        .data-cube.cube-6 { top: 80%; right: 3%; width: 60px; height: 60px; opacity: 0.18; animation-delay: -5s; }

        /* Purple accent cubes */
        .data-cube.accent {
            border-color: rgba(200, 80, 192, 0.08);
            background: rgba(200, 80, 192, 0.015);
        }

        .data-cube.accent::after {
            border-color: rgba(200, 80, 192, 0.04);
        }

        /* Floor glow effect */
        .floor-horizon {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100px;
            pointer-events: none;
            z-index: 0;
            background: linear-gradient(0deg,
                rgba(79, 195, 220, 0.015) 0%,
                transparent 100%);
        }

        .floor-horizon::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 1px;
            background: linear-gradient(90deg,
                transparent 0%,
                rgba(79, 195, 220, 0.1) 50%,
                transparent 100%);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header - Gibson Cyberspace Style */
        header {
            text-align: center;
            padding: 60px 0 50px;
            border-bottom: 1px solid var(--border-dark);
            margin-bottom: 30px;
            position: relative;
            background: var(--bg-deep);
            overflow: hidden;
        }

        /* SVG tower silhouettes */
        .header-towers {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            background-image:
                url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 120'%3E%3Crect x='5' y='20' width='8' height='100' fill='%234fc3dc' opacity='0.12'/%3E%3Crect x='18' y='35' width='6' height='85' fill='%234fc3dc' opacity='0.08'/%3E%3Crect x='28' y='10' width='10' height='110' fill='%234fc3dc' opacity='0.1'/%3E%3Crect x='42' y='45' width='5' height='75' fill='%234fc3dc' opacity='0.06'/%3E%3Crect x='52' y='25' width='7' height='95' fill='%234fc3dc' opacity='0.08'/%3E%3C/svg%3E"),
                url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 120'%3E%3Crect x='87' y='20' width='8' height='100' fill='%234fc3dc' opacity='0.12'/%3E%3Crect x='76' y='35' width='6' height='85' fill='%234fc3dc' opacity='0.08'/%3E%3Crect x='62' y='10' width='10' height='110' fill='%234fc3dc' opacity='0.1'/%3E%3Crect x='53' y='45' width='5' height='75' fill='%234fc3dc' opacity='0.06'/%3E%3Crect x='41' y='25' width='7' height='95' fill='%234fc3dc' opacity='0.08'/%3E%3C/svg%3E");
            background-position: left center, right center;
            background-repeat: no-repeat;
            background-size: 200px 100%, 200px 100%;
        }

        /* Perspective grid floor */
        .header-grid {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 50px;
            background:
                linear-gradient(180deg, transparent 0%, rgba(79, 195, 220, 0.03) 100%);
            transform-style: preserve-3d;
            perspective: 200px;
        }

        .header-grid::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 10%;
            right: 10%;
            height: 40px;
            background-image:
                repeating-linear-gradient(90deg,
                    rgba(79, 195, 220, 0.15) 0px,
                    rgba(79, 195, 220, 0.15) 1px,
                    transparent 1px,
                    transparent 40px),
                repeating-linear-gradient(0deg,
                    rgba(79, 195, 220, 0.1) 0px,
                    rgba(79, 195, 220, 0.1) 1px,
                    transparent 1px,
                    transparent 10px);
            transform: rotateX(60deg);
            transform-origin: bottom center;
            mask-image: linear-gradient(180deg, transparent 0%, black 30%, black 100%);
            -webkit-mask-image: linear-gradient(180deg, transparent 0%, black 30%, black 100%);
        }

        /* Vanishing point glow */
        .header-glow {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 35px;
            background: linear-gradient(180deg, transparent 0%, rgba(79, 195, 220, 0.5) 100%);
        }

        .header-glow::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 20px;
            background: radial-gradient(ellipse at center bottom, rgba(79, 195, 220, 0.25) 0%, transparent 70%);
        }

        header::before {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 1px;
            background: linear-gradient(90deg, transparent 10%, var(--neon-cyan-dim) 50%, transparent 90%);
            opacity: 0.8;
        }

        .header-content {
            position: relative;
            z-index: 2;
        }

        h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: 32px;
            font-weight: 900;
            letter-spacing: 12px;
            margin-bottom: 15px;
            position: relative;
            display: inline-block;
            background: linear-gradient(
                45deg,
                var(--neon-cyan) 0%,
                var(--neon-pink) 25%,
                var(--neon-cyan) 50%,
                var(--neon-pink) 75%,
                var(--neon-cyan) 100%
            );
            background-size: 300% 300%;
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            animation: lavaFlow 8s ease-in-out infinite;
        }

        @keyframes lavaFlow {
            0% { background-position: 0% 50%; }
            25% { background-position: 50% 100%; }
            50% { background-position: 100% 50%; }
            75% { background-position: 50% 0%; }
            100% { background-position: 0% 50%; }
        }

        /* Soft glow behind text */
        h1::before {
            content: 'NULL SECTOR';
            position: absolute;
            top: 0;
            left: 0;
            background: linear-gradient(
                45deg,
                var(--neon-cyan) 0%,
                var(--neon-pink) 25%,
                var(--neon-cyan) 50%,
                var(--neon-pink) 75%,
                var(--neon-cyan) 100%
            );
            background-size: 300% 300%;
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            filter: blur(8px);
            opacity: 0.5;
            animation: lavaFlow 8s ease-in-out infinite;
            z-index: -1;
        }

        .subtitle {
            font-family: 'Share Tech Mono', monospace;
            color: var(--neon-cyan-dim);
            font-size: 11px;
            letter-spacing: 8px;
            text-transform: uppercase;
        }

        /* Blinking cursor after subtitle */
        .subtitle::after {
            content: '_';
            animation: cursorBlink 1s step-end infinite;
            color: var(--neon-cyan);
            margin-left: 4px;
        }

        @keyframes cursorBlink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        /* Total Net Worth Display */
        .total-display {
            background:
                radial-gradient(ellipse at center, rgba(79, 195, 220, 0.03) 0%, transparent 70%),
                linear-gradient(180deg, rgba(12, 12, 22, 0.9) 0%, rgba(5, 5, 10, 0.95) 100%);
            border: 1px solid var(--border-dark);
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
            position: relative;
            box-shadow:
                0 0 30px rgba(79, 195, 220, 0.08),
                inset 0 1px 0 rgba(255, 255, 255, 0.05),
                inset 0 0 60px rgba(79, 195, 220, 0.02);
        }

        .total-display::before {
            content: 'CURRENT ASSETS';
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-deep);
            padding: 0 15px;
            color: var(--neon-cyan);
            font-size: 10px;
            font-family: 'Share Tech Mono', monospace;
            letter-spacing: 2px;
            opacity: 0.7;
        }

        .total-amount {
            font-family: 'Orbitron', sans-serif;
            font-size: 38px;
            font-weight: 700;
            color: var(--neon-cyan);
            text-shadow: 0 0 20px rgba(79, 195, 220, 0.5);
        }

        .future-total {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(0, 243, 255, 0.3);
        }

        .future-total .label {
            color: var(--text-dim);
            font-size: 11px;
            margin-bottom: 8px;
            letter-spacing: 2px;
        }

        .future-amount {
            font-family: 'Orbitron', sans-serif;
            font-size: 24px;
            color: var(--neon-pink);
            text-shadow: 0 0 15px var(--neon-pink), 0 0 30px rgba(255, 0, 255, 0.4);
        }

        /* Mission Progress Bar */
        .mission-progress {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border-dark);
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: var(--text-dim);
            margin-bottom: 8px;
        }

        .progress-label span:last-child {
            color: var(--sol-green);
        }

        .progress-track {
            height: 24px;
            background: var(--bg-deep);
            border: 2px solid var(--border-dark);
            padding: 3px;
            position: relative;
            overflow: visible;
        }

        .progress-segments {
            display: flex;
            height: 100%;
            gap: 2px;
            overflow: visible;
        }

        .progress-segment {
            flex: 1;
            background: var(--bg-panel-alt);
            transition: background 0.3s, box-shadow 0.3s;
        }

        .progress-segment.filled {
            /* Color set dynamically via JS */
        }

        .progress-segment.illuminate {
            filter: brightness(2.5);
            transform: scaleY(1.5);
            box-shadow: 0 0 20px currentColor, 0 0 40px currentColor !important;
            transition: filter 0.1s, transform 0.1s, box-shadow 0.1s;
        }

        .progress-target {
            font-size: 10px;
            color: var(--text-dim);
            margin-top: 6px;
            text-align: right;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.85; }
        }

        /* Grid Layout */
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .grid-full {
            grid-column: 1 / -1;
        }

        /* Panels - Glass Tower Aesthetic */
        .panel {
            background:
                linear-gradient(180deg, rgba(20, 20, 35, 0.4) 0%, rgba(8, 8, 15, 0.9) 100%),
                repeating-linear-gradient(
                    0deg,
                    transparent 0px,
                    transparent 2px,
                    rgba(255, 255, 255, 0.008) 2px,
                    rgba(255, 255, 255, 0.008) 4px
                );
            border: 1px solid var(--border-dark);
            position: relative;
            box-shadow:
                0 4px 20px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.03);
        }

        .panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(200, 80, 192, 0.3), transparent);
        }

        .panel::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(79, 195, 220, 0.15), transparent);
        }

        .panel-header {
            background:
                linear-gradient(180deg, rgba(74, 18, 89, 0.1) 0%, transparent 100%),
                rgba(12, 12, 22, 0.6);
            padding: 12px 15px;
            border-bottom: 1px solid rgba(200, 80, 192, 0.15);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-title {
            font-family: 'Orbitron', sans-serif;
            color: var(--neon-pink);
            font-size: 14px;
            font-weight: 700;
            letter-spacing: 2px;
        }

        .panel-body {
            padding: 15px;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 12px 10px;
            color: var(--text-dim);
            font-size: 12px;
            border-bottom: 1px solid var(--border-dark);
            letter-spacing: 1px;
        }

        td {
            padding: 12px 10px;
            border-bottom: 1px solid rgba(42, 42, 74, 0.5);
            font-size: 14px;
        }

        tr:hover {
            background: linear-gradient(90deg, rgba(200, 80, 192, 0.08) 0%, rgba(79, 195, 220, 0.03) 100%);
        }

        /* Income table column widths */
        #incomeTable th:first-child,
        #incomeTable td:first-child {
            min-width: 120px;
            width: 35%;
        }

        #incomeTable th:nth-child(2),
        #incomeTable td:nth-child(2),
        #incomeTable th:nth-child(3),
        #incomeTable td:nth-child(3),
        #incomeTable th:nth-child(4),
        #incomeTable td:nth-child(4) {
            width: 18%;
        }

        #incomeTable th:last-child,
        #incomeTable td:last-child {
            width: 40px;
        }

        /* Future table column widths */
        #futureTable th:first-child,
        #futureTable td:first-child {
            min-width: 120px;
            width: 35%;
        }

        #futureTable th:last-child,
        #futureTable td:last-child {
            width: 40px;
        }

        /* Expense table column widths */
        #expenseTable th:first-child,
        #expenseTable td:first-child {
            min-width: 140px;
            width: 55%;
        }

        #expenseTable th:last-child,
        #expenseTable td:last-child {
            width: 40px;
        }

        /* Assets table column widths */
        #assetsTable th:nth-child(2),
        #assetsTable td:nth-child(2) {
            min-width: 130px;
            width: 15%;
        }

        #assetsTable th:last-child,
        #assetsTable td:last-child {
            width: 40px;
        }

        /* Editable inputs */
        input, select {
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-family: 'Share Tech Mono', monospace;
            font-size: 14px;
            width: 100%;
            padding: 6px;
        }

        input:focus, select:focus {
            outline: none;
            background: rgba(0, 229, 255, 0.1);
            box-shadow: 0 0 10px rgba(0, 229, 255, 0.3);
        }

        input[type="number"] {
            text-align: right;
        }

        /* Custom Dropdown */
        .custom-select {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .custom-select.open {
            z-index: 10000;
        }

        .custom-select-trigger {
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-family: 'Press Start 2P', monospace;
            font-size: 9px;
            padding: 4px 18px 4px 4px;
            cursor: pointer;
            position: relative;
            white-space: nowrap;
        }

        .custom-select-trigger::after {
            content: '▾';
            position: absolute;
            right: 4px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 10px;
            color: var(--text-dim);
        }

        .custom-select.open .custom-select-trigger::after {
            content: '▴';
        }

        .custom-select-trigger:hover {
            color: var(--sol-cyan);
        }

        .custom-select-trigger:hover::after {
            color: var(--sol-cyan);
        }

        .custom-select-options {
            position: absolute;
            top: 100%;
            left: 0;
            min-width: 160px;
            background: var(--bg-panel);
            border: 1px solid var(--border-dark);
            display: none;
            z-index: 9999;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.6);
        }

        .custom-select.open .custom-select-options {
            display: block;
            max-height: 280px;
            overflow-y: auto;
        }

        .custom-select-option {
            padding: 7px 12px;
            font-family: 'Press Start 2P', monospace;
            font-size: 8px;
            color: var(--text-dim);
            cursor: pointer;
            white-space: nowrap;
            background: var(--bg-panel);
        }

        .custom-select-option:hover {
            background: rgba(79, 195, 220, 0.08);
            color: var(--neon-cyan);
        }

        .custom-select-option.selected {
            color: var(--neon-green);
            background: rgba(50, 205, 96, 0.06);
        }

        .custom-select-option.selected::before {
            content: '› ';
        }

        .panel.fullscreen .custom-select-trigger {
            font-size: 11px;
        }

        .panel.fullscreen .custom-select-option {
            font-size: 10px;
            padding: 8px 12px;
        }

        /* Value colors */
        .value-positive { color: var(--sol-green); }
        .value-crypto { color: var(--gold); }
        .value-percent { color: var(--sol-cyan); }

        /* Buttons - Hackers style */
        .btn {
            font-family: 'Share Tech Mono', monospace;
            font-size: 13px;
            padding: 12px 20px;
            border: 1px solid;
            cursor: pointer;
            transition: all 0.15s ease;
            background: transparent;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            border-color: var(--neon-pink-dim);
            color: var(--neon-pink);
        }

        .btn-primary:hover {
            background: rgba(200, 80, 192, 0.15);
            border-color: var(--neon-pink);
        }

        .btn-secondary {
            border-color: var(--border-dark);
            color: var(--neon-cyan);
        }

        .btn-secondary:hover {
            background: rgba(79, 195, 220, 0.1);
            border-color: var(--neon-cyan-dim);
        }

        .btn-danger {
            border-color: var(--warning-red);
            color: var(--warning-red);
            font-size: 10px;
            padding: 6px 12px;
            opacity: 0.8;
        }

        .btn-danger:hover {
            background: rgba(217, 68, 85, 0.15);
            opacity: 1;
        }

        .btn-small {
            font-size: 10px;
            padding: 6px 12px;
        }

        /* Energy Tank Bars (for asset allocation) */
        .energy-tanks {
            margin-top: 20px;
        }

        .energy-bar {
            margin-bottom: 12px;
        }

        .energy-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            font-size: 10px;
        }

        .energy-label .name { color: var(--text-dim); }
        .energy-label .value { color: var(--text-primary); }
        .energy-label .percent { color: var(--sol-cyan); }

        .energy-track {
            height: 16px;
            background: var(--bg-deep);
            border: 2px solid var(--border-dark);
            position: relative;
            overflow: hidden;
        }

        .energy-fill {
            height: 100%;
            transition: width 0.5s ease;
            position: relative;
        }

        .energy-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                90deg,
                transparent 0px,
                transparent 8px,
                rgba(0,0,0,0.3) 8px,
                rgba(0,0,0,0.3) 10px
            );
        }

        .energy-crypto { background: linear-gradient(90deg, #9945FF, #7733cc); }
        .energy-property { background: linear-gradient(90deg, #FF6B6B, #cc5555); }
        .energy-lowrisk { background: linear-gradient(90deg, #14F195, #10b870); }
        .energy-cash { background: linear-gradient(90deg, #00D1FF, #00a3cc); }
        .energy-receivables { background: linear-gradient(90deg, #FFD93D, #ccae31); }
        .energy-privatefund { background: linear-gradient(90deg, #FF8C42, #cc7035); }
        .energy-stocks { background: linear-gradient(90deg, #4D96FF, #3d78cc); }

        /* Income/Expense Section */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }

        .summary-box {
            background: var(--bg-panel-alt);
            border: 1px solid var(--border-dark);
            padding: 15px;
            text-align: center;
        }

        .summary-box .label {
            font-size: 9px;
            color: var(--text-dim);
            margin-bottom: 8px;
        }

        .summary-box .amount {
            font-size: 14px;
        }

        .summary-box.positive .amount { color: var(--sol-green); }
        .summary-box.warning .amount { color: var(--sol-purple); }
        .summary-box.highlight .amount { 
            color: var(--sol-cyan); 
            text-shadow: 0 0 10px var(--sol-cyan);
        }

        /* Monthly Leftover - Special Display */
        .monthly-leftover {
            background: linear-gradient(180deg, var(--bg-panel) 0%, rgba(0, 255, 136, 0.1) 100%);
            border: 2px solid var(--sol-green);
            padding: 20px;
            text-align: center;
            margin-top: 20px;
        }

        .monthly-leftover .label {
            color: var(--sol-green);
            font-size: 11px;
            margin-bottom: 10px;
        }

        .monthly-leftover .amount {
            font-size: 24px;
            color: var(--sol-green);
            text-shadow: 0 0 20px var(--sol-green);
        }

        /* Add buttons row */
        .add-row {
            margin-top: 10px;
            text-align: right;
        }

        /* Settings Panel */
        .settings-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-dark);
        }

        .settings-row:last-child {
            border-bottom: none;
        }

        .settings-label {
            color: var(--text-dim);
            font-size: 10px;
        }

        .settings-input {
            width: 100px;
            text-align: right;
            background: var(--bg-panel-alt);
            border: 1px solid var(--border-dark);
            padding: 8px;
        }

        /* Refresh status */
        .refresh-status {
            font-size: 10px;
            color: var(--text-dim);
        }

        .refresh-status.success {
            color: var(--sol-green);
        }

        .refresh-status.error {
            color: var(--warning-red);
        }

        /* Asset Types Manager */
        .type-tag {
            display: inline-block;
            padding: 6px 12px;
            margin: 3px;
            font-size: 12px;
            border: 1px solid var(--border-dark);
            background: var(--bg-panel-alt);
        }

        .type-tag .remove {
            color: var(--warning-red);
            cursor: pointer;
            margin-left: 6px;
        }

        /* Loading animation */
        .loading {
            display: inline-block;
            animation: blink 0.5s step-start infinite;
        }

        @keyframes blink {
            50% { opacity: 0; }
        }

        /* Responsive */
        @media (max-width: 900px) {
            .grid {
                grid-template-columns: 1fr;
            }

            h1 { font-size: 18px; }
            .total-amount { font-size: 28px; }
        }

        /* Chart Grid */
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 30px;
            padding: 20px 0;
        }

        @media (max-width: 1100px) {
            .chart-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 600px) {
            .chart-grid {
                grid-template-columns: 1fr;
            }
        }

        .chart-container {
            text-align: center;
        }

        .chart-label {
            color: var(--sol-purple);
            font-size: 11px;
            letter-spacing: 2px;
            margin-bottom: 15px;
        }

        .chart-container canvas {
            image-rendering: pixelated;
            image-rendering: crisp-edges;
            display: block;
            margin: 0 auto;
            width: 320px;
            height: 320px;
        }

        .chart-legend {
            margin-top: 15px;
            text-align: left;
            font-size: 9px;
            max-height: 180px;
            overflow-y: auto;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
        }

        .legend-color {
            width: 10px;
            height: 10px;
            margin-right: 6px;
            flex-shrink: 0;
        }

        .legend-text {
            color: var(--text-dim);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .legend-value {
            color: var(--text-primary);
            margin-left: auto;
            padding-left: 8px;
        }

        /* Fullscreen Panels - only Visual Scan */
        #visualScanPanel {
            cursor: pointer;
        }

        #visualScanPanel .panel-header::after {
            content: 'CLICK TO EXPAND';
            font-size: 7px;
            color: var(--text-dim);
            margin-left: 15px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        #visualScanPanel:hover .panel-header::after {
            opacity: 1;
        }

        .panel.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 9000;
            margin: 0;
            border: none;
            overflow: auto;
            background: var(--bg-deep);
        }

        .panel.fullscreen .panel-body {
            min-height: calc(100vh - 60px);
            padding: 30px;
        }

        .panel.fullscreen .panel-header::after {
            content: 'ESC TO EXIT';
            opacity: 1;
        }

        .panel.fullscreen table {
            font-size: 14px;
        }

        .panel.fullscreen th,
        .panel.fullscreen td {
            padding: 15px 12px;
        }

        .panel.fullscreen input,
        .panel.fullscreen select {
            font-size: 14px;
        }

        /* Visual Scan Fullscreen - Centered Charts */
        #visualScanPanel.fullscreen .panel-body {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: calc(100vh - 60px);
            padding: 40px;
        }

        #visualScanPanel.fullscreen .chart-grid {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 60px;
            flex-wrap: wrap;
        }

        #visualScanPanel.fullscreen .chart-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #visualScanPanel.fullscreen .chart-container canvas {
            width: 350px;
            height: 350px;
        }

        #visualScanPanel.fullscreen .chart-label {
            font-size: 12px;
            margin-bottom: 20px;
        }

        #visualScanPanel.fullscreen .chart-legend {
            font-size: 9px;
            max-height: 200px;
        }

        /* Lock Screen - Hackers Style */
        .lock-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(180deg, #000000 0%, #030308 50%, #050510 100%);
            z-index: 99999;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            perspective: 1000px;
        }

        .demo-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: transparent;
            border: 1px solid rgba(79, 195, 220, 0.2);
            color: var(--text-dim);
            font-family: 'Share Tech Mono', monospace;
            font-size: 10px;
            letter-spacing: 2px;
            padding: 6px 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .demo-btn:hover {
            border-color: rgba(79, 195, 220, 0.5);
            color: var(--neon-cyan);
            background: rgba(79, 195, 220, 0.05);
        }

        .hidden {
            display: none !important;
        }

        .lock-screen.hidden {
            display: none;
        }

        /* Gibson Cyberspace - 3D Perspective Container */
        .lock-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            transform-style: preserve-3d;
        }

        /* Circuit Floor - Perspective Grid */
        .lock-grid {
            position: absolute;
            bottom: 0;
            left: -50%;
            width: 200%;
            height: 60%;
            transform: rotateX(70deg) translateZ(-100px);
            transform-origin: center bottom;
            background-image:
                /* Main grid lines */
                linear-gradient(90deg, rgba(79, 195, 220, 0.15) 1px, transparent 1px),
                linear-gradient(0deg, rgba(79, 195, 220, 0.12) 1px, transparent 1px),
                /* Thicker circuit traces */
                linear-gradient(90deg, transparent 29px, rgba(200, 80, 192, 0.1) 29px, rgba(200, 80, 192, 0.1) 31px, transparent 31px),
                linear-gradient(0deg, transparent 59px, rgba(200, 80, 192, 0.08) 59px, rgba(200, 80, 192, 0.08) 61px, transparent 61px),
                /* Circuit pads */
                radial-gradient(circle at 30px 60px, rgba(79, 195, 220, 0.2) 2px, transparent 2px);
            background-size: 30px 30px, 30px 30px, 60px 60px, 60px 60px, 60px 60px;
            pointer-events: none;
            mask-image: linear-gradient(to top, rgba(0,0,0,1) 0%, rgba(0,0,0,0.8) 50%, transparent 100%);
            -webkit-mask-image: linear-gradient(to top, rgba(0,0,0,1) 0%, rgba(0,0,0,0.8) 50%, transparent 100%);
        }

        /* Data Towers Container */
        .data-towers {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            perspective: 800px;
        }

        /* Individual Data Tower */
        .data-tower {
            position: absolute;
            width: 60px;
            background: linear-gradient(180deg,
                rgba(79, 195, 220, 0.03) 0%,
                rgba(8, 8, 15, 0.95) 100%);
            border: 1px solid rgba(79, 195, 220, 0.15);
            border-bottom: none;
            overflow: hidden;
            transform-origin: bottom center;
        }

        .data-tower::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                repeating-linear-gradient(
                    0deg,
                    transparent 0px,
                    transparent 8px,
                    rgba(79, 195, 220, 0.05) 8px,
                    rgba(79, 195, 220, 0.05) 9px
                );
        }

        /* Data scrolling on towers */
        .data-tower::after {
            content: '010110100101011010010101\A110101001010110100101011\A001010110100101011010010\A101101001010110100101011\A010101101001010110100101\A110100101011010010101101\A001010110100101011010010';
            white-space: pre;
            position: absolute;
            top: 0;
            left: 2px;
            font-family: 'Share Tech Mono', monospace;
            font-size: 6px;
            line-height: 1.4;
            color: rgba(79, 195, 220, 0.4);
            animation: dataScroll 8s linear infinite;
        }

        @keyframes dataScroll {
            0% { transform: translateY(0); }
            100% { transform: translateY(-50%); }
        }

        /* Tower positions - left side */
        .data-tower.left-1 { left: 2%; bottom: 20%; height: 55%; width: 50px; opacity: 0.9; }
        .data-tower.left-2 { left: 6%; bottom: 18%; height: 70%; width: 45px; opacity: 0.8; }
        .data-tower.left-3 { left: 10%; bottom: 22%; height: 50%; width: 40px; opacity: 0.7; }
        .data-tower.left-4 { left: 14%; bottom: 20%; height: 62%; width: 55px; opacity: 0.75; }
        .data-tower.left-5 { left: 19%; bottom: 25%; height: 45%; width: 35px; opacity: 0.6; }
        .data-tower.left-6 { left: 23%; bottom: 22%; height: 52%; width: 42px; opacity: 0.55; }
        .data-tower.left-7 { left: 27%; bottom: 28%; height: 38%; width: 30px; opacity: 0.45; }

        /* Tower positions - right side */
        .data-tower.right-1 { right: 2%; bottom: 20%; height: 58%; width: 48px; opacity: 0.9; }
        .data-tower.right-2 { right: 6%; bottom: 18%; height: 68%; width: 52px; opacity: 0.8; }
        .data-tower.right-3 { right: 11%; bottom: 21%; height: 48%; width: 38px; opacity: 0.7; }
        .data-tower.right-4 { right: 15%; bottom: 19%; height: 65%; width: 50px; opacity: 0.75; }
        .data-tower.right-5 { right: 20%; bottom: 24%; height: 42%; width: 36px; opacity: 0.6; }
        .data-tower.right-6 { right: 24%; bottom: 23%; height: 50%; width: 40px; opacity: 0.55; }
        .data-tower.right-7 { right: 28%; bottom: 27%; height: 35%; width: 28px; opacity: 0.45; }

        /* Purple accent towers */
        .data-tower.accent {
            border-color: rgba(200, 80, 192, 0.2);
            background: linear-gradient(180deg,
                rgba(200, 80, 192, 0.04) 0%,
                rgba(8, 8, 15, 0.95) 100%);
        }

        .data-tower.accent::after {
            color: rgba(200, 80, 192, 0.35);
        }

        /* Distant horizon glow */
        .horizon-glow {
            position: absolute;
            bottom: 30%;
            left: 50%;
            transform: translateX(-50%);
            width: 300px;
            height: 200px;
            background: radial-gradient(ellipse at center bottom,
                rgba(79, 195, 220, 0.08) 0%,
                rgba(79, 195, 220, 0.03) 40%,
                transparent 70%);
            pointer-events: none;
        }

        .lock-scanline {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(200, 80, 192, 0.3), rgba(79, 195, 220, 0.3), transparent);
            animation: scanline 4s linear infinite;
            pointer-events: none;
            z-index: 10;
        }

        @keyframes scanline {
            0% { top: 0; }
            100% { top: 100%; }
        }

        .lock-content {
            text-align: center;
            z-index: 1;
            position: relative;
            padding: 50px 60px;
            background:
                radial-gradient(ellipse at center, rgba(8, 8, 15, 0.9) 0%, rgba(3, 3, 8, 0.85) 100%);
            border: 1px solid rgba(79, 195, 220, 0.1);
            box-shadow:
                0 0 60px rgba(0, 0, 0, 0.8),
                0 0 100px rgba(79, 195, 220, 0.05),
                inset 0 0 60px rgba(0, 0, 0, 0.3);
        }

        .lock-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(79, 195, 220, 0.3), transparent);
        }

        .lock-content::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(200, 80, 192, 0.2), transparent);
        }

        .lock-icon {
            margin-bottom: 30px;
            opacity: 0.8;
        }

        .lock-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 24px;
            font-weight: 700;
            color: var(--neon-cyan);
            text-shadow: 0 0 20px rgba(79, 195, 220, 0.4);
            letter-spacing: 8px;
            margin-bottom: 15px;
        }

        .lock-subtitle {
            font-family: 'Share Tech Mono', monospace;
            font-size: 11px;
            color: var(--text-dim);
            letter-spacing: 4px;
            margin-bottom: 40px;
        }

        .lock-input-container {
            margin-bottom: 20px;
        }

        .lock-input {
            display: block;
            background: rgba(3, 3, 8, 0.9);
            border: 1px solid rgba(79, 195, 220, 0.2);
            color: var(--neon-cyan);
            font-family: 'Share Tech Mono', monospace;
            font-size: 14px;
            padding: 16px 28px;
            width: 360px;
            text-align: center;
            letter-spacing: 3px;
            margin: 0 auto 15px auto;
            transition: all 0.2s ease;
        }

        .lock-input:focus {
            outline: none;
            border-color: rgba(79, 195, 220, 0.4);
            background: rgba(5, 5, 12, 0.95);
            box-shadow: 0 0 20px rgba(79, 195, 220, 0.1);
        }

        .lock-input::placeholder {
            color: var(--text-dim);
            letter-spacing: 2px;
        }

        .lock-error {
            color: var(--warning-red);
            font-size: 11px;
            margin-top: 15px;
            height: 20px;
        }

        .lock-hint {
            font-size: 11px;
            color: var(--text-dim);
            letter-spacing: 3px;
        }

        .lock-restore {
            margin-top: 30px;
            font-size: 11px;
            color: var(--text-dim);
            letter-spacing: 2px;
        }

        .lock-restore.hidden {
            display: none;
        }

        .btn-link {
            background: none;
            border: none;
            color: var(--neon-green);
            font-family: inherit;
            font-size: 11px;
            letter-spacing: 2px;
            cursor: pointer;
            text-decoration: none;
            padding: 0;
            margin-left: 8px;
            transition: all 0.3s;
        }

        .btn-link:hover {
            color: var(--neon-pink);
            text-shadow: 0 0 10px var(--neon-pink);
        }

        .lock-screen.shake .lock-input {
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-10px); }
            40%, 80% { transform: translateX(10px); }
        }

        /* Vault Unlock Transition */
        .vault-transition {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: transparent;
            z-index: 99998;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            perspective: 1200px;
        }

        .vault-transition.hidden {
            display: none;
        }

        /* Vault Door Panels - Split screen that opens */
        .vault-door-panel {
            position: absolute;
            top: 0;
            width: 50%;
            height: 100%;
            background:
                /* Vertical data tower lines */
                repeating-linear-gradient(90deg,
                    transparent 0px,
                    transparent 30px,
                    rgba(79, 195, 220, 0.04) 30px,
                    rgba(79, 195, 220, 0.04) 32px,
                    transparent 32px,
                    transparent 45px,
                    rgba(200, 80, 192, 0.03) 45px,
                    rgba(200, 80, 192, 0.03) 46px,
                    transparent 46px,
                    transparent 70px,
                    rgba(79, 195, 220, 0.05) 70px,
                    rgba(79, 195, 220, 0.05) 73px,
                    transparent 73px,
                    transparent 100px),
                /* Horizontal circuit traces */
                repeating-linear-gradient(0deg,
                    transparent 0px,
                    transparent 80px,
                    rgba(79, 195, 220, 0.025) 80px,
                    rgba(79, 195, 220, 0.025) 81px,
                    transparent 81px,
                    transparent 150px),
                /* Base gradient */
                linear-gradient(180deg, #030308 0%, #050510 50%, #030308 100%);
            transition: transform 1.5s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }

        .vault-door-panel::before {
            content: '';
            position: absolute;
            top: 0;
            width: 100%;
            height: 100%;
            background:
                /* Grid nodes */
                radial-gradient(circle at 50px 80px, rgba(79, 195, 220, 0.08) 0px, transparent 3px),
                radial-gradient(circle at 120px 160px, rgba(200, 80, 192, 0.06) 0px, transparent 3px),
                radial-gradient(circle at 80px 240px, rgba(79, 195, 220, 0.07) 0px, transparent 3px),
                radial-gradient(circle at 150px 320px, rgba(79, 195, 220, 0.05) 0px, transparent 3px),
                radial-gradient(circle at 40px 400px, rgba(200, 80, 192, 0.06) 0px, transparent 3px);
        }

        .vault-door-panel::after {
            content: '';
            position: absolute;
            top: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 0, 0, 0.1) 0px,
                rgba(0, 0, 0, 0.1) 1px,
                transparent 1px,
                transparent 3px
            );
            pointer-events: none;
        }

        .vault-door-panel.left {
            left: 0;
            transform-origin: left center;
            border-right: 2px solid rgba(79, 195, 220, 0.15);
        }

        .vault-door-panel.left::before {
            /* Gradient fade from edge */
            background:
                linear-gradient(90deg, rgba(79, 195, 220, 0.03) 0%, transparent 30%),
                radial-gradient(circle at 50px 80px, rgba(79, 195, 220, 0.08) 0px, transparent 3px),
                radial-gradient(circle at 120px 160px, rgba(200, 80, 192, 0.06) 0px, transparent 3px),
                radial-gradient(circle at 80px 240px, rgba(79, 195, 220, 0.07) 0px, transparent 3px);
        }

        .vault-door-panel.right {
            right: 0;
            transform-origin: right center;
            border-left: 2px solid rgba(79, 195, 220, 0.15);
        }

        .vault-door-panel.right::before {
            /* Gradient fade from edge */
            background:
                linear-gradient(-90deg, rgba(79, 195, 220, 0.03) 0%, transparent 30%),
                radial-gradient(circle at calc(100% - 50px) 80px, rgba(79, 195, 220, 0.08) 0px, transparent 3px),
                radial-gradient(circle at calc(100% - 120px) 160px, rgba(200, 80, 192, 0.06) 0px, transparent 3px),
                radial-gradient(circle at calc(100% - 80px) 240px, rgba(79, 195, 220, 0.07) 0px, transparent 3px);
        }

        /* Split lock halves inside door panels */
        .vault-lock-half {
            position: absolute;
            top: 50%;
            width: 300px;
            height: 300px;
            transform: translateY(-50%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .vault-lock-half.visible {
            opacity: 1;
        }

        .vault-door-panel.left .vault-lock-half {
            right: 0;
            transform: translateY(-50%) translateX(50%);
            clip-path: inset(0 50% 0 0);
        }

        .vault-door-panel.right .vault-lock-half {
            left: 0;
            transform: translateY(-50%) translateX(-50%);
            clip-path: inset(0 0 0 50%);
        }

        /* Door opening animation - slide into walls */
        .vault-transition.doors-opening .vault-door-panel.left {
            transform: translateX(-100%);
        }

        .vault-transition.doors-opening .vault-door-panel.right {
            transform: translateX(100%);
        }

        .vault-transition.doors-opening .decrypt-status,
        .vault-transition.doors-opening .vault-status,
        .vault-transition.doors-opening .hex-rain {
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        /* Final fade out */
        .vault-transition.fade-complete {
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        /* Center seam glow when opening */
        .vault-transition.doors-opening::after {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg,
                transparent 0%,
                rgba(79, 195, 220, 0.4) 20%,
                rgba(79, 195, 220, 0.6) 50%,
                rgba(79, 195, 220, 0.4) 80%,
                transparent 100%);
            box-shadow: 0 0 30px rgba(79, 195, 220, 0.5), 0 0 60px rgba(79, 195, 220, 0.3);
            animation: seamGlow 1.5s ease-out forwards;
        }

        @keyframes seamGlow {
            0% { opacity: 0; width: 2px; }
            20% { opacity: 1; width: 4px; }
            100% { opacity: 0; width: 100px; }
        }

        /* Decryption Status */
        .decrypt-status {
            position: absolute;
            top: 50px;
            left: 50px;
            text-align: left;
            z-index: 10;
        }

        .decrypt-line {
            font-size: 14px;
            color: rgba(79, 195, 220, 0.7);
            margin-bottom: 12px;
            opacity: 0;
            letter-spacing: 1px;
        }

        .decrypt-line.active {
            opacity: 1;
            color: var(--neon-cyan);
            animation: typeIn 0.3s ease-out;
        }

        .decrypt-line.complete {
            opacity: 1;
            color: var(--neon-cyan);
        }

        .decrypt-line .status {
            color: rgba(200, 80, 192, 0.5);
        }

        @keyframes typeIn {
            0% { opacity: 0; transform: translateX(-10px); }
            100% { opacity: 1; transform: translateX(0); }
        }

        /* Hex data stream background */
        .hex-rain {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            opacity: 0.6;
            pointer-events: none;
            z-index: 5;
        }

        .hex-column {
            position: absolute;
            top: -100%;
            font-size: 10px;
            line-height: 1.5;
            animation: hexFall linear infinite, hexColorFade 8s ease-in-out infinite;
        }

        @keyframes hexFall {
            0% { transform: translateY(0); }
            100% { transform: translateY(200vh); }
        }

        @keyframes hexColorFade {
            0%, 100% { color: #7a5078; }
            25% { color: #5a6080; }
            50% { color: #4a7078; }
            75% { color: #6a5080; }
        }

        /* Vault Door */
        .vault-door-container {
            position: relative;
            width: 300px;
            height: 300px;
            opacity: 0.6;
            z-index: 10;
        }

        .vault-door {
            width: 100%;
            height: 100%;
            border: 3px solid var(--border-dark);
            border-radius: 50%;
            background:
                repeating-radial-gradient(
                    circle at 50% 50%,
                    transparent 0px,
                    transparent 3px,
                    rgba(255, 255, 255, 0.008) 3px,
                    rgba(255, 255, 255, 0.008) 6px
                ),
                radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.03) 0%, transparent 50%),
                linear-gradient(135deg, #0a0a15 0%, #050508 50%, #0a0a15 100%);
            position: relative;
            box-shadow:
                0 0 20px rgba(74, 18, 89, 0.1),
                inset 0 0 60px rgba(0, 0, 0, 0.8),
                inset 0 1px 2px rgba(255, 255, 255, 0.03);
        }

        .vault-door::before {
            content: '';
            position: absolute;
            top: 8px;
            left: 8px;
            right: 8px;
            bottom: 8px;
            border: 2px solid rgba(21, 21, 37, 0.8);
            border-radius: 50%;
            box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.4);
        }

        .vault-door::after {
            content: '';
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            bottom: 20px;
            border: 1px solid rgba(74, 18, 89, 0.2);
            border-radius: 50%;
            background: repeating-conic-gradient(
                from 0deg,
                transparent 0deg 14deg,
                rgba(74, 18, 89, 0.08) 14deg 15deg,
                transparent 15deg 30deg
            );
        }

        /* Vault wheel/handle */
        .vault-wheel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 160px;
            height: 160px;
            border: 2px solid rgba(53, 127, 145, 0.5);
            border-radius: 50%;
            background:
                repeating-conic-gradient(
                    from 0deg,
                    rgba(79, 195, 220, 0.02) 0deg 5deg,
                    transparent 5deg 10deg
                ),
                radial-gradient(circle at 40% 40%, rgba(79, 195, 220, 0.04) 0%, transparent 40%),
                linear-gradient(145deg, #080810 0%, #040406 50%, #060610 100%);
            box-shadow:
                0 0 15px rgba(79, 195, 220, 0.08),
                inset 0 0 20px rgba(0, 0, 0, 0.6),
                inset 0 1px 2px rgba(255, 255, 255, 0.02);
        }

        .vault-wheel::before {
            content: '';
            position: absolute;
            top: 6px;
            left: 6px;
            right: 6px;
            bottom: 6px;
            border: 1px solid var(--neon-pink-dim);
            border-radius: 50%;
            opacity: 0.5;
        }

        .vault-wheel::after {
            content: '';
            position: absolute;
            top: 16px;
            left: 16px;
            right: 16px;
            bottom: 16px;
            border: 1px solid var(--neon-green-dim);
            border-radius: 50%;
            opacity: 0.3;
            background: repeating-conic-gradient(
                from 15deg,
                transparent 0deg 28deg,
                rgba(50, 205, 96, 0.05) 28deg 30deg
            );
        }

        .vault-wheel.spinning {
            animation: spinWheel 2s ease-in-out forwards;
        }

        @keyframes spinWheel {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(720deg); }
        }

        .vault-wheel-spoke {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 68px;
            height: 6px;
            background:
                linear-gradient(180deg, rgba(255, 255, 255, 0.1) 0%, transparent 50%, rgba(0, 0, 0, 0.2) 100%),
                linear-gradient(90deg, var(--neon-cyan-dim) 0%, var(--neon-cyan-dim) 65%, transparent 65%);
            transform-origin: left center;
            border-radius: 3px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.4);
        }

        .vault-wheel-spoke::before {
            content: '';
            position: absolute;
            right: 8px;
            top: -4px;
            width: 14px;
            height: 14px;
            background:
                radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.15) 0%, transparent 50%),
                linear-gradient(145deg, #12121f 0%, #08080f 100%);
            border: 1px solid var(--neon-pink-dim);
            border-radius: 3px;
            box-shadow: inset 0 1px 1px rgba(255, 255, 255, 0.1);
        }

        .vault-wheel-spoke::after {
            content: '';
            position: absolute;
            right: 12px;
            top: 1px;
            width: 4px;
            height: 4px;
            background: var(--neon-pink-dim);
            border-radius: 50%;
            opacity: 0.6;
        }

        .vault-wheel-spoke:nth-child(1) { transform: translateY(-50%) rotate(0deg); }
        .vault-wheel-spoke:nth-child(2) { transform: translateY(-50%) rotate(60deg); }
        .vault-wheel-spoke:nth-child(3) { transform: translateY(-50%) rotate(120deg); }
        .vault-wheel-spoke:nth-child(4) { transform: translateY(-50%) rotate(180deg); }
        .vault-wheel-spoke:nth-child(5) { transform: translateY(-50%) rotate(240deg); }
        .vault-wheel-spoke:nth-child(6) { transform: translateY(-50%) rotate(300deg); }

        .vault-wheel-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 44px;
            height: 44px;
            background:
                radial-gradient(circle at 35% 35%, rgba(255, 255, 255, 0.1) 0%, transparent 40%),
                radial-gradient(circle, var(--neon-pink-dim) 0%, #0a050a 60%, var(--bg-deep) 100%);
            border: 3px solid var(--neon-pink-dim);
            border-radius: 50%;
            box-shadow:
                0 0 15px rgba(200, 80, 192, 0.2),
                inset 0 0 15px rgba(0, 0, 0, 0.6),
                inset 0 1px 2px rgba(255, 255, 255, 0.1);
        }

        .vault-wheel-center::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 12px;
            height: 12px;
            background:
                radial-gradient(circle at 40% 40%, rgba(255, 255, 255, 0.3) 0%, transparent 50%),
                radial-gradient(circle, var(--neon-green) 0%, #081008 100%);
            border: 1px solid var(--neon-green-dim);
            border-radius: 50%;
            box-shadow: 0 0 8px rgba(50, 205, 96, 0.3);
            animation: centerPulse 3s ease-in-out infinite;
        }

        @keyframes centerPulse {
            0%, 100% { box-shadow: 0 0 6px rgba(50, 205, 96, 0.2); }
            50% { box-shadow: 0 0 10px rgba(50, 205, 96, 0.4); }
        }

        .vault-wheel-center::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            right: 3px;
            bottom: 3px;
            border: 1px solid rgba(200, 80, 192, 0.3);
            border-radius: 50%;
            background: repeating-conic-gradient(
                from 0deg,
                transparent 0deg 10deg,
                rgba(255, 0, 255, 0.1) 10deg 11deg,
                transparent 11deg 20deg
            );
        }

        .vault-wheel-ticks {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .vault-wheel-tick {
            position: absolute;
            top: 4px;
            left: 50%;
            width: 2px;
            height: 8px;
            background: linear-gradient(180deg, var(--neon-cyan-dim) 0%, rgba(79, 195, 220, 0.2) 100%);
            transform-origin: center 76px;
            opacity: 0.5;
            border-radius: 1px;
        }

        .vault-wheel-tick:nth-child(3n) {
            height: 12px;
            width: 3px;
            opacity: 0.7;
            background: linear-gradient(180deg, var(--neon-pink-dim) 0%, rgba(200, 80, 192, 0.2) 100%);
        }

        /* Lock bolts around the door */
        .vault-bolt {
            position: absolute;
            width: 30px;
            height: 10px;
            background:
                linear-gradient(180deg, rgba(255, 255, 255, 0.15) 0%, transparent 30%, rgba(0, 0, 0, 0.2) 100%),
                linear-gradient(90deg, var(--warning-red) 0%, #c95555 50%, var(--warning-red) 100%);
            box-shadow: 0 0 8px rgba(217, 68, 85, 0.3);
            border-radius: 2px;
            border: 1px solid rgba(217, 68, 85, 0.4);
        }

        .vault-bolt::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 3px;
            right: 3px;
            height: 1px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 1px;
        }

        .vault-bolt.unlocked {
            background:
                linear-gradient(180deg, rgba(255, 255, 255, 0.15) 0%, transparent 30%, rgba(0, 0, 0, 0.2) 100%),
                linear-gradient(90deg, var(--neon-green-dim) 0%, #55c970 50%, var(--neon-green-dim) 100%);
            box-shadow: 0 0 8px rgba(50, 205, 96, 0.3);
            border-color: rgba(50, 205, 96, 0.4);
            animation: boltRetract 0.3s ease-out forwards;
        }

        .vault-bolt-top { top: 20px; left: 50%; transform: translateX(-50%); }
        .vault-bolt-right { right: 20px; top: 50%; transform: translateY(-50%) rotate(90deg); }
        .vault-bolt-bottom { bottom: 20px; left: 50%; transform: translateX(-50%); }
        .vault-bolt-left { left: 20px; top: 50%; transform: translateY(-50%) rotate(90deg); }

        @keyframes boltRetract {
            0% { opacity: 1; }
            50% { opacity: 1; transform: translateX(-50%) scaleX(1.2); }
            100% { opacity: 0.3; transform: translateX(-50%) scaleX(0.3); }
        }

        .vault-bolt-right.unlocked {
            animation: boltRetractH 0.3s ease-out forwards;
        }
        .vault-bolt-left.unlocked {
            animation: boltRetractH 0.3s ease-out forwards;
        }

        @keyframes boltRetractH {
            0% { opacity: 1; }
            50% { opacity: 1; }
            100% { opacity: 0.3; transform: translateY(-50%) rotate(90deg) scaleX(0.3); }
        }

        /* Door opening animation */
        .vault-door-container.opening {
            animation: vaultOpen 1.2s ease-in forwards;
        }

        @keyframes vaultOpen {
            0% {
                transform: perspective(800px) translateZ(0) scale(1) rotateX(0);
                opacity: 0.6;
            }
            20% {
                transform: perspective(800px) translateZ(50px) scale(1.02) rotateX(-2deg);
                opacity: 0.6;
            }
            40% {
                transform: perspective(800px) translateZ(-100px) scale(0.9) rotateX(5deg);
                opacity: 0.5;
            }
            100% {
                transform: perspective(800px) translateZ(-800px) scale(0.3) rotateX(15deg);
                opacity: 0;
            }
        }

        /* Vault transition break-through effect */
        .vault-transition.breaking::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 10px;
            height: 10px;
            background: radial-gradient(circle, rgba(79, 195, 220, 0.4) 0%, transparent 70%);
            border-radius: 50%;
            animation: breakthroughGlow 1.2s ease-out forwards;
        }

        @keyframes breakthroughGlow {
            0% {
                width: 10px;
                height: 10px;
                opacity: 0;
            }
            30% {
                width: 50px;
                height: 50px;
                opacity: 1;
            }
            100% {
                width: 200vw;
                height: 200vh;
                opacity: 0;
            }
        }

        /* Access granted text */
        .vault-status {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, 180px);
            font-size: 12px;
            color: var(--sol-green);
            letter-spacing: 4px;
            opacity: 0;
            z-index: 10;
        }

        .vault-status.show {
            animation: statusFlash 0.5s ease-out forwards;
        }

        @keyframes statusFlash {
            0% { opacity: 0; }
            50% { opacity: 1; text-shadow: 0 0 20px var(--sol-green); }
            100% { opacity: 1; }
        }

        .vault-status.granted {
            color: var(--sol-green);
            text-shadow: 0 0 30px var(--sol-green);
            animation: grantedPulse 0.3s ease-out infinite;
        }

        @keyframes grantedPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Debug Modal */
        .debug-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.9);
            z-index: 100000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }

        .debug-modal.hidden {
            display: none;
        }

        .debug-content {
            background: var(--bg-panel);
            border: 2px solid var(--sol-purple);
            max-width: 900px;
            width: 100%;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }

        .debug-header {
            padding: 15px 20px;
            border-bottom: 2px solid var(--border-dark);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .debug-title {
            color: var(--sol-purple);
            font-size: 12px;
            letter-spacing: 2px;
        }

        .debug-close {
            background: none;
            border: 2px solid var(--warning-red);
            color: var(--warning-red);
            font-family: 'Press Start 2P', monospace;
            font-size: 10px;
            padding: 8px 12px;
            cursor: pointer;
        }

        .debug-close:hover {
            background: var(--warning-red);
            color: var(--bg-deep);
        }

        .debug-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .debug-data {
            background: var(--bg-deep);
            border: 1px solid var(--border-dark);
            padding: 15px;
            font-size: 9px;
            color: var(--sol-green);
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 60vh;
            overflow-y: auto;
        }

        .debug-status {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid var(--border-dark);
            font-size: 10px;
        }

        .debug-status-item {
            margin-bottom: 5px;
        }

        .debug-status-label {
            color: var(--text-dim);
        }

        .debug-status-value {
            color: var(--sol-cyan);
        }

        .debug-status-encrypted {
            color: var(--sol-green);
        }

        .debug-status-decrypted {
            color: var(--warning-red);
        }

        /* Backup Password Modal */
        .backup-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.95);
            z-index: 100001;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .backup-modal.hidden {
            display: none;
        }

        .backup-modal-content {
            text-align: center;
            padding: 40px;
        }

        .backup-modal-title {
            font-size: 18px;
            color: var(--sol-cyan);
            letter-spacing: 4px;
            margin-bottom: 10px;
        }

        .backup-modal-subtitle {
            font-size: 10px;
            color: var(--text-dim);
            letter-spacing: 2px;
            margin-bottom: 30px;
        }

        .backup-modal-content .lock-input {
            margin-bottom: 15px;
        }

        .backup-modal-error {
            color: var(--warning-red);
            font-size: 10px;
            letter-spacing: 2px;
            margin-bottom: 15px;
            height: 15px;
        }

        .backup-modal-error.hidden {
            visibility: hidden;
        }

        .backup-modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .reset-warning {
            color: var(--warning-red);
            font-size: 10px;
            letter-spacing: 2px;
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid var(--warning-red);
            background: rgba(255, 0, 68, 0.1);
        }

        /* Fireworks Canvas */
        #fireworksCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9998;
        }

        /* Celebration Overlay */
        .celebration-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            z-index: 9997;
            background: radial-gradient(ellipse at center, rgba(10, 10, 15, 0.8) 0%, transparent 70%);
        }

        .celebration-overlay.hidden {
            display: none;
        }

        .celebration-amount {
            font-size: 72px;
            color: var(--sol-green);
            text-shadow: 
                0 0 20px var(--sol-green),
                0 0 40px var(--sol-green),
                0 0 80px var(--sol-green),
                0 0 120px rgba(20, 241, 149, 0.5);
            animation: celebrationPulse 0.5s ease-out forwards, celebrationGlow 1s ease-in-out 0.5s infinite;
            letter-spacing: 8px;
        }

        .celebration-subtitle {
            font-size: 16px;
            color: var(--sol-cyan);
            text-shadow: 0 0 20px var(--sol-cyan), 0 0 40px var(--sol-cyan);
            letter-spacing: 12px;
            margin-top: 20px;
            animation: celebrationFadeIn 0.8s ease-out 0.3s both;
        }

        @keyframes celebrationPulse {
            0% {
                transform: scale(0);
                opacity: 0;
            }
            50% {
                transform: scale(1.2);
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes celebrationGlow {
            0%, 100% {
                text-shadow: 
                    0 0 20px var(--sol-green),
                    0 0 40px var(--sol-green),
                    0 0 80px var(--sol-green),
                    0 0 120px rgba(20, 241, 149, 0.5);
            }
            50% {
                text-shadow: 
                    0 0 30px var(--sol-green),
                    0 0 60px var(--sol-green),
                    0 0 100px var(--sol-green),
                    0 0 160px rgba(20, 241, 149, 0.7);
            }
        }

        @keyframes celebrationFadeIn {
            0% {
                opacity: 0;
                transform: translateY(20px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 900px) {
            .celebration-amount {
                font-size: 36px;
                letter-spacing: 4px;
            }
            .celebration-subtitle {
                font-size: 10px;
                letter-spacing: 6px;
            }
        }
    </style>
</head>
<body>
    <!-- CRT Effects -->
    <div class="noise-overlay"></div>
    <div class="circuit-bg"></div>
    <div class="floating-cubes">
        <div class="data-cube cube-1"></div>
        <div class="data-cube cube-2 accent"></div>
        <div class="data-cube cube-3"></div>
        <div class="data-cube cube-4"></div>
        <div class="data-cube cube-5 accent"></div>
        <div class="data-cube cube-6"></div>
    </div>
    <div class="floor-horizon"></div>
    <div class="page-scanline"></div>

    <!-- Lock Screen -->
    <div id="lockScreen" class="lock-screen">
        <button class="demo-btn" onclick="runDemo()">DEMO</button>
        <div class="lock-container">
            <div class="lock-grid"></div>
            <!-- Gibson Data Towers -->
            <div class="data-towers">
                <div class="data-tower left-1"></div>
                <div class="data-tower left-2 accent"></div>
                <div class="data-tower left-3"></div>
                <div class="data-tower left-4"></div>
                <div class="data-tower left-5 accent"></div>
                <div class="data-tower left-6"></div>
                <div class="data-tower left-7"></div>
                <div class="data-tower right-1"></div>
                <div class="data-tower right-2 accent"></div>
                <div class="data-tower right-3"></div>
                <div class="data-tower right-4"></div>
                <div class="data-tower right-5 accent"></div>
                <div class="data-tower right-6"></div>
                <div class="data-tower right-7"></div>
            </div>
            <div class="horizon-glow"></div>
            <div class="lock-content">
                <div class="lock-icon">
                    <svg viewBox="0 0 80 80" width="100" height="100">
                        <!-- Data Tower Icon - Gibson style -->
                        <!-- Central tower -->
                        <rect x="30" y="15" width="20" height="50" fill="none" stroke="#4fc3dc" stroke-width="1.5" opacity="0.8"/>
                        <line x1="32" y1="20" x2="48" y2="20" stroke="#4fc3dc" stroke-width="0.5" opacity="0.4"/>
                        <line x1="32" y1="25" x2="48" y2="25" stroke="#4fc3dc" stroke-width="0.5" opacity="0.4"/>
                        <line x1="32" y1="30" x2="48" y2="30" stroke="#4fc3dc" stroke-width="0.5" opacity="0.4"/>
                        <line x1="32" y1="35" x2="48" y2="35" stroke="#4fc3dc" stroke-width="0.5" opacity="0.4"/>
                        <line x1="32" y1="40" x2="48" y2="40" stroke="#4fc3dc" stroke-width="0.5" opacity="0.4"/>
                        <line x1="32" y1="45" x2="48" y2="45" stroke="#4fc3dc" stroke-width="0.5" opacity="0.4"/>
                        <line x1="32" y1="50" x2="48" y2="50" stroke="#4fc3dc" stroke-width="0.5" opacity="0.4"/>
                        <line x1="32" y1="55" x2="48" y2="55" stroke="#4fc3dc" stroke-width="0.5" opacity="0.4"/>
                        <line x1="32" y1="60" x2="48" y2="60" stroke="#4fc3dc" stroke-width="0.5" opacity="0.4"/>
                        <!-- Left tower -->
                        <rect x="12" y="28" width="14" height="37" fill="none" stroke="#c850c0" stroke-width="1" opacity="0.5"/>
                        <line x1="14" y1="33" x2="24" y2="33" stroke="#c850c0" stroke-width="0.5" opacity="0.3"/>
                        <line x1="14" y1="38" x2="24" y2="38" stroke="#c850c0" stroke-width="0.5" opacity="0.3"/>
                        <line x1="14" y1="43" x2="24" y2="43" stroke="#c850c0" stroke-width="0.5" opacity="0.3"/>
                        <line x1="14" y1="48" x2="24" y2="48" stroke="#c850c0" stroke-width="0.5" opacity="0.3"/>
                        <line x1="14" y1="53" x2="24" y2="53" stroke="#c850c0" stroke-width="0.5" opacity="0.3"/>
                        <line x1="14" y1="58" x2="24" y2="58" stroke="#c850c0" stroke-width="0.5" opacity="0.3"/>
                        <!-- Right tower -->
                        <rect x="54" y="22" width="14" height="43" fill="none" stroke="#c850c0" stroke-width="1" opacity="0.5"/>
                        <line x1="56" y1="27" x2="66" y2="27" stroke="#c850c0" stroke-width="0.5" opacity="0.3"/>
                        <line x1="56" y1="32" x2="66" y2="32" stroke="#c850c0" stroke-width="0.5" opacity="0.3"/>
                        <line x1="56" y1="37" x2="66" y2="37" stroke="#c850c0" stroke-width="0.5" opacity="0.3"/>
                        <line x1="56" y1="42" x2="66" y2="42" stroke="#c850c0" stroke-width="0.5" opacity="0.3"/>
                        <line x1="56" y1="47" x2="66" y2="47" stroke="#c850c0" stroke-width="0.5" opacity="0.3"/>
                        <line x1="56" y1="52" x2="66" y2="52" stroke="#c850c0" stroke-width="0.5" opacity="0.3"/>
                        <line x1="56" y1="57" x2="66" y2="57" stroke="#c850c0" stroke-width="0.5" opacity="0.3"/>
                        <!-- Circuit floor traces -->
                        <line x1="10" y1="65" x2="70" y2="65" stroke="#4fc3dc" stroke-width="1" opacity="0.3"/>
                        <line x1="20" y1="70" x2="60" y2="70" stroke="#4fc3dc" stroke-width="0.5" opacity="0.2"/>
                        <line x1="30" y1="75" x2="50" y2="75" stroke="#4fc3dc" stroke-width="0.5" opacity="0.15"/>
                        <!-- Vertical circuit traces -->
                        <line x1="19" y1="65" x2="19" y2="70" stroke="#4fc3dc" stroke-width="0.5" opacity="0.2"/>
                        <line x1="61" y1="65" x2="61" y2="70" stroke="#4fc3dc" stroke-width="0.5" opacity="0.2"/>
                        <line x1="40" y1="65" x2="40" y2="75" stroke="#c850c0" stroke-width="0.5" opacity="0.25"/>
                    </svg>
                </div>
                <div class="lock-title" id="lockTitle">INITIALIZE KERNEL</div>
                <div class="lock-subtitle" id="lockSubtitle">// ENTER ROOT PASSWORD</div>
                <div class="lock-input-container">
                    <input type="password" id="passwordInput" class="lock-input" placeholder="NEW ACCESS CODE" autocomplete="off">
                    <input type="password" id="passwordConfirm" class="lock-input" placeholder="RE-ENTER ACCESS CODE" autocomplete="off">
                    <div class="lock-error" id="lockError"></div>
                </div>
                <div class="lock-hint" id="lockHint">THIS WILL BE YOUR PASSWORD</div>
                <div id="lockRestore" class="lock-restore">
                    <span>Have a backup?</span>
                    <button class="btn-link" onclick="document.getElementById('lockImportFile').click()">RESTORE FROM BACKUP</button>
                    <input type="file" id="lockImportFile" style="display:none" accept=".enc,.json" onchange="importData(event)">
                </div>
            </div>
            <div class="lock-scanline"></div>
        </div>
    </div>

    <!-- Vault Unlock Transition -->
    <div id="vaultTransition" class="vault-transition hidden">
        <div class="vault-door-panel left">
            <div class="vault-lock-half" id="vaultLockLeft">
                <div class="vault-door">
                    <div class="vault-bolt vault-bolt-top" id="boltTopLeft"></div>
                    <div class="vault-bolt vault-bolt-right" id="boltRightLeft"></div>
                    <div class="vault-bolt vault-bolt-bottom" id="boltBottomLeft"></div>
                    <div class="vault-bolt vault-bolt-left" id="boltLeftLeft"></div>
                    <div class="vault-wheel" id="vaultWheelLeft">
                        <div class="vault-wheel-ticks">
                            <div class="vault-wheel-tick" style="transform: translateX(-50%) rotate(0deg)"></div>
                            <div class="vault-wheel-tick" style="transform: translateX(-50%) rotate(30deg)"></div>
                            <div class="vault-wheel-tick" style="transform: translateX(-50%) rotate(60deg)"></div>
                            <div class="vault-wheel-tick" style="transform: translateX(-50%) rotate(90deg)"></div>
                            <div class="vault-wheel-tick" style="transform: translateX(-50%) rotate(120deg)"></div>
                            <div class="vault-wheel-tick" style="transform: translateX(-50%) rotate(150deg)"></div>
                            <div class="vault-wheel-tick" style="transform: translateX(-50%) rotate(180deg)"></div>
                            <div class="vault-wheel-tick" style="transform: translateX(-50%) rotate(210deg)"></div>
                            <div class="vault-wheel-tick" style="transform: translateX(-50%) rotate(240deg)"></div>
                            <div class="vault-wheel-tick" style="transform: translateX(-50%) rotate(270deg)"></div>
                            <div class="vault-wheel-tick" style="transform: translateX(-50%) rotate(300deg)"></div>
                            <div class="vault-wheel-tick" style="transform: translateX(-50%) rotate(330deg)"></div>
                        </div>
                        <div class="vault-wheel-spoke"></div>
                        <div class="vault-wheel-spoke"></div>
                        <div class="vault-wheel-spoke"></div>
                        <div class="vault-wheel-spoke"></div>
                        <div class="vault-wheel-spoke"></div>
                        <div class="vault-wheel-spoke"></div>
                        <div class="vault-wheel-center"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="vault-door-panel right">
            <div class="vault-lock-half" id="vaultLockRight">
                <div class="vault-door">
                    <div class="vault-bolt vault-bolt-top" id="boltTopRight"></div>
                    <div class="vault-bolt vault-bolt-right" id="boltRightRight"></div>
                    <div class="vault-bolt vault-bolt-bottom" id="boltBottomRight"></div>
                    <div class="vault-bolt vault-bolt-left" id="boltLeftRight"></div>
                    <div class="vault-wheel" id="vaultWheelRight">
                        <div class="vault-wheel-ticks">
                            <div class="vault-wheel-tick" style="transform: translateX(-50%) rotate(0deg)"></div>
                            <div class="vault-wheel-tick" style="transform: translateX(-50%) rotate(30deg)"></div>
                            <div class="vault-wheel-tick" style="transform: translateX(-50%) rotate(60deg)"></div>
                            <div class="vault-wheel-tick" style="transform: translateX(-50%) rotate(90deg)"></div>
                            <div class="vault-wheel-tick" style="transform: translateX(-50%) rotate(120deg)"></div>
                            <div class="vault-wheel-tick" style="transform: translateX(-50%) rotate(150deg)"></div>
                            <div class="vault-wheel-tick" style="transform: translateX(-50%) rotate(180deg)"></div>
                            <div class="vault-wheel-tick" style="transform: translateX(-50%) rotate(210deg)"></div>
                            <div class="vault-wheel-tick" style="transform: translateX(-50%) rotate(240deg)"></div>
                            <div class="vault-wheel-tick" style="transform: translateX(-50%) rotate(270deg)"></div>
                            <div class="vault-wheel-tick" style="transform: translateX(-50%) rotate(300deg)"></div>
                            <div class="vault-wheel-tick" style="transform: translateX(-50%) rotate(330deg)"></div>
                        </div>
                        <div class="vault-wheel-spoke"></div>
                        <div class="vault-wheel-spoke"></div>
                        <div class="vault-wheel-spoke"></div>
                        <div class="vault-wheel-spoke"></div>
                        <div class="vault-wheel-spoke"></div>
                        <div class="vault-wheel-spoke"></div>
                        <div class="vault-wheel-center"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="hex-rain" id="hexRain"></div>
        <div class="decrypt-status" id="decryptStatus">
            <div class="decrypt-line" id="decrypt1">> VERIFYING CREDENTIALS...</div>
            <div class="decrypt-line" id="decrypt2">> DECRYPTING SECURE KEYS... <span class="status"></span></div>
            <div class="decrypt-line" id="decrypt3">> AUTHENTICATING BIOMETRICS...</div>
            <div class="decrypt-line" id="decrypt4">> DISENGAGING LOCK MECHANISMS...</div>
            <div class="decrypt-line" id="decrypt5">> ACCESS GRANTED</div>
        </div>
        <div class="vault-status" id="vaultStatus">INITIALIZING...</div>
    </div>

    <!-- Debug Modal -->
    <div id="debugModal" class="debug-modal hidden">
        <div class="debug-content">
            <div class="debug-header">
                <span class="debug-title">STORAGE DEBUG</span>
                <button class="debug-close" onclick="closeDebugModal()">CLOSE [ESC]</button>
            </div>
            <div class="debug-body">
                <div class="debug-status" id="debugStatus"></div>
                <div class="debug-data" id="debugData"></div>
            </div>
        </div>
    </div>

    <!-- Backup Password Modal -->
    <div id="backupModal" class="backup-modal hidden">
        <div class="backup-modal-content">
            <div class="backup-modal-title">RESTORE BACKUP</div>
            <div class="backup-modal-subtitle">ENTER BACKUP PASSWORD</div>
            <input type="password" id="backupPasswordInput" class="lock-input" placeholder="BACKUP PASSWORD" autocomplete="off">
            <div class="backup-modal-error hidden" id="backupError">DECRYPTION FAILED</div>
            <div class="backup-modal-buttons">
                <button class="btn btn-secondary" onclick="cancelBackupRestore()">CANCEL</button>
                <button class="btn btn-primary" onclick="confirmBackupRestore()">DECRYPT</button>
            </div>
        </div>
    </div>

    <!-- Reset Vault Modal -->
    <div id="resetModal" class="backup-modal hidden">
        <div class="backup-modal-content">
            <div class="backup-modal-title" style="color: var(--warning-red)">RESET VAULT</div>
            <div class="backup-modal-subtitle" id="resetSubtitle">THIS WILL DELETE ALL ENCRYPTED DATA</div>
            <div class="reset-warning" id="resetWarning">MAKE SURE YOU HAVE EXPORTED YOUR DATA FIRST</div>
            <div class="backup-modal-buttons">
                <button class="btn btn-secondary" onclick="cancelReset()">CANCEL</button>
                <button class="btn btn-danger" id="resetConfirmBtn" onclick="confirmReset()">CONFIRM RESET</button>
            </div>
        </div>
    </div>

    <!-- Notification Modal -->
    <div id="notifyModal" class="backup-modal hidden">
        <div class="backup-modal-content">
            <div class="backup-modal-title" id="notifyTitle">NOTICE</div>
            <div class="backup-modal-subtitle" id="notifyMessage"></div>
            <div class="backup-modal-buttons">
                <button class="btn btn-primary" onclick="closeNotify()">OK</button>
            </div>
        </div>
    </div>

    <div class="container">
        <canvas id="fireworksCanvas"></canvas>
        <div id="celebrationOverlay" class="celebration-overlay hidden">
            <div class="celebration-amount">$10,000,000</div>
            <div class="celebration-subtitle">WORM DISABLED</div>
        </div>
        <header>
            <div class="header-towers"></div>
            <div class="header-grid"></div>
            <div class="header-glow"></div>
            <div class="header-content">
                <h1>NULL SECTOR</h1>
                <div class="subtitle">FINANCIAL SYSTEMS ONLINE</div>
            </div>
        </header>

        <!-- Total Net Worth -->
        <div class="total-display">
            <div class="total-amount" id="totalNetWorth">$0.00</div>
            <div class="future-total">
                <div class="label">PROJECTED (INCL. VESTING)</div>
                <div class="future-amount" id="futureNetWorth">$0.00</div>
            </div>
            <div class="mission-progress">
                <div class="progress-label">
                    <span>MISSION PROGRESS</span>
                    <span id="progressPercent">0%</span>
                </div>
                <div class="progress-track">
                    <div class="progress-segments" id="progressSegments"></div>
                </div>
                <div class="progress-target">TARGET: $10,000,000</div>
            </div>
        </div>

        <div class="grid">
            <!-- Assets Panel -->
            <div class="panel grid-full">
                <div class="panel-header">
                    <span class="panel-title">◆ INVENTORY</span>
                    <div>
                        <button class="btn btn-primary btn-small" onclick="refreshPrices()" id="refreshBtn">
                            REFRESH PRICES
                        </button>
                        <span class="refresh-status" id="refreshStatus"></span>
                    </div>
                </div>
                <div class="panel-body">
                    <table id="assetsTable">
                        <thead>
                            <tr>
                                <th>ASSET</th>
                                <th>TYPE</th>
                                <th style="text-align:right">UNITS</th>
                                <th style="text-align:right">PRICE</th>
                                <th style="text-align:right">VALUE</th>
                                <th style="text-align:right">%</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="assetsBody"></tbody>
                    </table>
                    <div class="add-row">
                        <button class="btn btn-secondary btn-small" onclick="addAsset()">+ ADD ASSET</button>
                    </div>
                </div>
            </div>

            <!-- Asset Type Breakdown -->
            <div class="panel">
                <div class="panel-header">
                    <span class="panel-title">◆ ENERGY ALLOCATION</span>
                </div>
                <div class="panel-body">
                    <div class="energy-tanks" id="energyTanks"></div>
                </div>
            </div>

            <!-- Future/Vesting -->
            <div class="panel">
                <div class="panel-header">
                    <span class="panel-title">◆ TIME LOCKS</span>
                </div>
                <div class="panel-body">
                    <table id="futureTable">
                        <thead>
                            <tr>
                                <th>ASSET</th>
                                <th style="text-align:right">AMOUNT</th>
                                <th style="text-align:right">PRICE</th>
                                <th style="text-align:right">VALUE</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="futureBody"></tbody>
                    </table>
                    <div class="add-row">
                        <button class="btn btn-secondary btn-small" onclick="addFutureAsset()">+ ADD VESTING</button>
                    </div>
                </div>
            </div>

            <!-- Income Sources -->
            <div class="panel">
                <div class="panel-header">
                    <span class="panel-title">◆ SUPPLY LINES</span>
                </div>
                <div class="panel-body">
                    <table id="incomeTable">
                        <thead>
                            <tr>
                                <th>SOURCE</th>
                                <th style="text-align:right">BASE</th>
                                <th style="text-align:right">RATE</th>
                                <th style="text-align:right">YEARLY</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="incomeBody"></tbody>
                    </table>
                    <div class="add-row">
                        <button class="btn btn-secondary btn-small" onclick="addIncome()">+ ADD INCOME</button>
                    </div>
                </div>
            </div>

            <!-- Expenses -->
            <div class="panel">
                <div class="panel-header">
                    <span class="panel-title">◆ BURN RATE</span>
                </div>
                <div class="panel-body">
                    <table id="expenseTable">
                        <thead>
                            <tr>
                                <th>EXPENSE</th>
                                <th style="text-align:right">YEARLY</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="expenseBody"></tbody>
                    </table>
                    <div class="add-row">
                        <button class="btn btn-secondary btn-small" onclick="addExpense()">+ ADD EXPENSE</button>
                    </div>
                </div>
            </div>

            <!-- Summary -->
            <div class="panel grid-full">
                <div class="panel-header">
                    <span class="panel-title">◆ SCAN RESULTS</span>
                </div>
                <div class="panel-body">
                    <div class="summary-grid">
                        <div class="summary-box positive">
                            <div class="label">YEARLY PRE-TAX</div>
                            <div class="amount" id="yearlyPreTax">$0.00</div>
                        </div>
                        <div class="summary-box warning">
                            <div class="label">YEARLY POST-TAX</div>
                            <div class="amount" id="yearlyPostTax">$0.00</div>
                        </div>
                        <div class="summary-box">
                            <div class="label">TOTAL EXPENSES</div>
                            <div class="amount" id="totalExpenses">$0.00</div>
                        </div>
                        <div class="summary-box highlight">
                            <div class="label">REMAINING</div>
                            <div class="amount" id="yearlyRemaining">$0.00</div>
                        </div>
                    </div>
                    <div class="monthly-leftover">
                        <div class="label">▶ MONTHLY SURPLUS ◀</div>
                        <div class="amount" id="monthlyLeftover">$0.00</div>
                    </div>
                </div>
            </div>

            <!-- Visuals -->
            <div class="panel grid-full" id="visualScanPanel" onclick="toggleFullscreen(event)">
                <div class="panel-header">
                    <span class="panel-title">◆ VISUAL SCAN</span>
                </div>
                <div class="panel-body">
                    <div class="chart-grid">
                        <div class="chart-container">
                            <div class="chart-label">INVENTORY</div>
                            <canvas id="chartInventory" width="320" height="320"></canvas>
                            <div class="chart-legend" id="legendInventory"></div>
                        </div>
                        <div class="chart-container">
                            <div class="chart-label">ENERGY ALLOCATION</div>
                            <canvas id="chartEnergy" width="320" height="320"></canvas>
                            <div class="chart-legend" id="legendEnergy"></div>
                        </div>
                        <div class="chart-container">
                            <div class="chart-label">SUPPLY LINES</div>
                            <canvas id="chartSupply" width="320" height="320"></canvas>
                            <div class="chart-legend" id="legendSupply"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings -->
            <div class="panel grid-full">
                <div class="panel-header">
                    <span class="panel-title">◆ TERMINAL</span>
                </div>
                <div class="panel-body">
                    <div class="settings-row">
                        <span class="settings-label">TAX RATE (%)</span>
                        <input type="number" class="settings-input" id="taxRate" value="37" step="0.1" onchange="saveSettings(); recalculate();">
                    </div>
                    <div class="settings-row">
                        <span class="settings-label">ASSET TYPES</span>
                        <div>
                            <div id="typesList"></div>
                            <input type="text" placeholder="Add type..." style="width: 120px; margin-top: 8px;" id="newTypeInput" onkeypress="if(event.key==='Enter')addAssetType()">
                        </div>
                    </div>
                    <div class="settings-row">
                        <span class="settings-label">DATA BACKUP</span>
                        <div>
                            <button class="btn btn-secondary btn-small" onclick="exportData()">EXPORT</button>
                            <button class="btn btn-secondary btn-small" onclick="document.getElementById('importFile').click()">IMPORT</button>
                            <button class="btn btn-danger btn-small" onclick="clearAllData()">RESET VAULT</button>
                            <input type="file" id="importFile" style="display:none" accept=".enc,.json" onchange="importData(event)">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // =====================
        // LOCK SCREEN
        // =====================

        const LOCK_TIMEOUT = 10 * 60 * 1000; // 10 minutes
        const STORAGE_KEY = 'nullSectorData';
        const ENCRYPTED_MARKER = 'ENCRYPTED:';
        const PBKDF2_ITERATIONS = 1000000; // 1M iterations
        let lockTimer = null;
        let isLocked = true;
        let isFirstTimeSetup = false; // True when no password has been set yet
        let isPricesLoading = false;
        let isDecrypting = false; // True while decryption is in progress
        let cachedCryptoKey = null; // Derived CryptoKey held in memory while unlocked
        let cachedSalt = null; // Salt used for current encryption
        let pendingPassword = null; // Temporarily holds password during unlock transition

        function checkFirstTimeSetup() {
            const stored = localStorage.getItem(STORAGE_KEY);
            isFirstTimeSetup = !stored || !stored.startsWith(ENCRYPTED_MARKER);
            updateLockScreenMode();
        }

        function updateLockScreenMode() {
            const title = document.getElementById('lockTitle');
            const subtitle = document.getElementById('lockSubtitle');
            const confirmInput = document.getElementById('passwordConfirm');
            const hint = document.getElementById('lockHint');
            const passwordInput = document.getElementById('passwordInput');
            const restoreOption = document.getElementById('lockRestore');

            if (isFirstTimeSetup) {
                title.textContent = 'INITIALIZE KERNEL';
                subtitle.textContent = '// CREATE ROOT ACCESS';
                confirmInput.classList.remove('hidden');
                confirmInput.placeholder = 'CONFIRM PASSWORD';
                hint.textContent = 'THIS WILL BE YOUR ROOT PASSWORD';
                passwordInput.placeholder = 'NEW PASSWORD';
                restoreOption.classList.remove('hidden');
            } else {
                title.textContent = 'ACCESS DENIED';
                subtitle.textContent = '// AUTHENTICATION REQUIRED';
                confirmInput.classList.add('hidden');
                hint.textContent = 'PRESS ENTER TO HACK IN';
                passwordInput.placeholder = 'ENTER PASSWORD';
                restoreOption.classList.add('hidden');
            }
        }

        // =====================
        // ENCRYPTION SYSTEM
        // =====================

        async function deriveKey(password, salt) {
            const encoder = new TextEncoder();
            const keyMaterial = await crypto.subtle.importKey(
                'raw',
                encoder.encode(password),
                'PBKDF2',
                false,
                ['deriveKey']
            );
            return crypto.subtle.deriveKey(
                {
                    name: 'PBKDF2',
                    salt: salt,
                    iterations: PBKDF2_ITERATIONS,
                    hash: 'SHA-256'
                },
                keyMaterial,
                { name: 'AES-GCM', length: 256 },
                false,
                ['encrypt', 'decrypt']
            );
        }

        // Fast encryption using cached key (key derivation already done)
        async function encryptWithCachedKey(plaintext) {
            if (!cachedCryptoKey || !cachedSalt) {
                throw new Error('No encryption key available');
            }

            const encoder = new TextEncoder();
            const iv = crypto.getRandomValues(new Uint8Array(12));

            const encrypted = await crypto.subtle.encrypt(
                { name: 'AES-GCM', iv: iv },
                cachedCryptoKey,
                encoder.encode(plaintext)
            );

            // Combine salt + iv + ciphertext and base64 encode
            const combined = new Uint8Array(cachedSalt.length + iv.length + encrypted.byteLength);
            combined.set(cachedSalt, 0);
            combined.set(iv, cachedSalt.length);
            combined.set(new Uint8Array(encrypted), cachedSalt.length + iv.length);

            return ENCRYPTED_MARKER + btoa(String.fromCharCode(...combined));
        }

        async function decryptData(encryptedData, password) {
            try {
                if (!encryptedData.startsWith(ENCRYPTED_MARKER)) {
                    return { data: encryptedData, salt: null }; // Not encrypted, return as-is
                }

                const combined = Uint8Array.from(
                    atob(encryptedData.slice(ENCRYPTED_MARKER.length)),
                    c => c.charCodeAt(0)
                );

                const salt = combined.slice(0, 16);
                const iv = combined.slice(16, 28);
                const ciphertext = combined.slice(28);

                const key = await deriveKey(password, salt);

                const decrypted = await crypto.subtle.decrypt(
                    { name: 'AES-GCM', iv: iv },
                    key,
                    ciphertext
                );

                return {
                    data: new TextDecoder().decode(decrypted),
                    salt: salt,
                    key: key
                };
            } catch (e) {
                console.error('Decryption failed:', e);
                return null;
            }
        }

        // Initialize encryption for new data (first time setup)
        async function initializeEncryption(password) {
            const salt = crypto.getRandomValues(new Uint8Array(16));
            const key = await deriveKey(password, salt);
            return { salt, key };
        }

        async function attemptUnlock() {
            const input = document.getElementById('passwordInput');
            const confirmInput = document.getElementById('passwordConfirm');
            const error = document.getElementById('lockError');
            const lockScreen = document.getElementById('lockScreen');

            const password = input.value;
            if (!password) {
                error.textContent = 'ENTER PASSWORD';
                return;
            }

            // First time setup - validate password confirmation
            if (isFirstTimeSetup) {
                const confirm = confirmInput.value;

                if (!confirm) {
                    error.textContent = 'CONFIRM PASSWORD';
                    confirmInput.focus();
                    return;
                }

                if (password !== confirm) {
                    error.textContent = 'PASSWORDS DO NOT MATCH';
                    lockScreen.classList.add('shake');
                    setTimeout(() => lockScreen.classList.remove('shake'), 500);
                    confirmInput.value = '';
                    confirmInput.focus();
                    return;
                }

                if (password.length < 4) {
                    error.textContent = 'PASSWORD TOO SHORT';
                    return;
                }

                // Passwords match - proceed with setup
                isLocked = false;
                pendingPassword = password;
                input.value = '';
                confirmInput.value = '';
                error.textContent = '';
                isFirstTimeSetup = false;
                startVaultTransition();
                return;
            }

            // Normal unlock - try to decrypt
            error.textContent = 'VERIFYING...';
            input.disabled = true;

            try {
                const stored = localStorage.getItem(STORAGE_KEY);
                const result = await decryptData(stored, password);

                if (result && result.data) {
                    // Password correct - decryption succeeded
                    isLocked = false;
                    pendingPassword = password;
                    input.value = '';
                    error.textContent = '';
                    input.disabled = false;
                    startVaultTransition();
                } else {
                    throw new Error('Decryption failed');
                }
            } catch (e) {
                // Wrong password - decryption failed
                error.textContent = 'ACCESS DENIED';
                lockScreen.classList.add('shake');
                setTimeout(() => lockScreen.classList.remove('shake'), 500);
                input.value = '';
                input.disabled = false;
                input.focus();
            }
        }

        async function completeUnlock() {
            // Show loading state while decrypting
            isDecrypting = true;
            recalculate(); // Update UI to show loading

            // Demo mode - load demo data instead of decrypting
            if (isDemoMode) {
                data = JSON.parse(JSON.stringify(DEMO_DATA));
                isDecrypting = false;
                document.getElementById('taxRate').value = data.settings.taxRate;
                recalculate();
                fetchCryptoPrices();
                return;
            }

            const stored = localStorage.getItem(STORAGE_KEY);

            if (stored && stored.startsWith(ENCRYPTED_MARKER)) {
                // Decrypt existing encrypted data
                const result = await decryptData(stored, pendingPassword);
                if (result) {
                    data = JSON.parse(result.data);
                    cachedCryptoKey = result.key;
                    cachedSalt = result.salt;
                }
            } else {
                // First time or unencrypted data - initialize encryption
                const { salt, key } = await initializeEncryption(pendingPassword);
                cachedCryptoKey = key;
                cachedSalt = salt;

                // If there was unencrypted data, encrypt it now
                if (stored) {
                    data = JSON.parse(stored);
                }
                // Save encrypted immediately
                await saveDataEncrypted();
            }

            pendingPassword = null;
            isDecrypting = false;

            // Refresh UI with decrypted data
            document.getElementById('taxRate').value = data.settings.taxRate;
            recalculate();

            resetLockTimer();
            startPriceAutoRefresh();
        }

        function startVaultTransition() {
            const lockScreen = document.getElementById('lockScreen');
            const vaultTransition = document.getElementById('vaultTransition');
            const vaultStatus = document.getElementById('vaultStatus');
            const vaultLockLeft = document.getElementById('vaultLockLeft');
            const vaultLockRight = document.getElementById('vaultLockRight');

            // Hide lock screen, show vault transition
            lockScreen.classList.add('hidden');
            vaultTransition.classList.remove('hidden');

            // Generate hex rain background
            generateHexRain();

            // Start the sequence
            let time = 0;

            // Show status
            vaultStatus.classList.add('show');
            vaultStatus.textContent = 'INITIALIZING...';

            // Decrypt line 1: Verifying credentials
            time += 300;
            setTimeout(() => {
                document.getElementById('decrypt1').classList.add('active');
                vaultStatus.textContent = 'VERIFYING...';
            }, time);

            // Show lock halves and start wheel spinning
            time += 400;
            setTimeout(() => {
                vaultLockLeft.classList.add('visible');
                vaultLockRight.classList.add('visible');
                document.getElementById('vaultWheelLeft').classList.add('spinning');
                document.getElementById('vaultWheelRight').classList.add('spinning');
            }, time);

            // Decrypt line 2: Decrypting keys (with progress)
            time += 500;
            setTimeout(() => {
                document.getElementById('decrypt1').classList.add('complete');
                document.getElementById('decrypt2').classList.add('active');
                vaultStatus.textContent = 'DECRYPTING...';
                animateDecryptProgress();
            }, time);

            // Decrypt line 3: Authenticating
            time += 800;
            setTimeout(() => {
                document.getElementById('decrypt2').classList.add('complete');
                document.getElementById('decrypt3').classList.add('active');
                vaultStatus.textContent = 'AUTHENTICATING...';
            }, time);

            // Decrypt line 4: Disengaging locks
            time += 600;
            setTimeout(() => {
                document.getElementById('decrypt3').classList.add('complete');
                document.getElementById('decrypt4').classList.add('active');
                vaultStatus.textContent = 'UNLOCKING...';
            }, time);

            // Unlock bolts one by one (both halves)
            time += 300;
            setTimeout(() => {
                document.getElementById('boltTopLeft').classList.add('unlocked');
                document.getElementById('boltTopRight').classList.add('unlocked');
            }, time);
            time += 200;
            setTimeout(() => {
                document.getElementById('boltRightLeft').classList.add('unlocked');
                document.getElementById('boltRightRight').classList.add('unlocked');
            }, time);
            time += 200;
            setTimeout(() => {
                document.getElementById('boltBottomLeft').classList.add('unlocked');
                document.getElementById('boltBottomRight').classList.add('unlocked');
            }, time);
            time += 200;
            setTimeout(() => {
                document.getElementById('boltLeftLeft').classList.add('unlocked');
                document.getElementById('boltLeftRight').classList.add('unlocked');
            }, time);

            // Access granted
            time += 400;
            setTimeout(() => {
                document.getElementById('decrypt4').classList.add('complete');
                document.getElementById('decrypt5').classList.add('active');
                document.getElementById('decrypt5').style.color = 'var(--sol-green)';
                document.getElementById('decrypt5').style.textShadow = '0 0 10px var(--sol-green)';
                vaultStatus.textContent = 'ACCESS GRANTED';
                vaultStatus.classList.add('granted');
            }, time);

            // Open the vault doors - split screen effect
            time += 500;
            setTimeout(() => {
                vaultTransition.classList.add('doors-opening');
            }, time);

            // Start fade out as doors finish opening
            time += 1500;
            setTimeout(() => {
                vaultTransition.classList.add('fade-complete');
            }, time);

            // Cleanup and show dashboard
            time += 600;
            setTimeout(() => {
                vaultTransition.classList.add('hidden');
                vaultTransition.classList.remove('doors-opening', 'fade-complete');
                resetVaultTransition();
                completeUnlock();
            }, time);
        }

        function generateHexRain() {
            const hexRain = document.getElementById('hexRain');
            hexRain.innerHTML = '';
            const chars = '0123456789ABCDEF';
            const spacing = 18;
            const columns = Math.floor(window.innerWidth / spacing);

            for (let i = 0; i < columns; i++) {
                const column = document.createElement('div');
                column.className = 'hex-column';
                column.style.left = (i * spacing) + 'px';
                column.style.animationDuration = (6 + Math.random() * 6) + 's';
                // Start at random points in the animation so code is already flowing
                column.style.animationDelay = (-Math.random() * 5) + 's';

                // Generate random hex string
                let hex = '';
                for (let j = 0; j < 40; j++) {
                    hex += chars[Math.floor(Math.random() * 16)];
                    hex += chars[Math.floor(Math.random() * 16)];
                    hex += '\n';
                }
                column.textContent = hex;
                hexRain.appendChild(column);
            }
        }

        function animateDecryptProgress() {
            const statusSpan = document.querySelector('#decrypt2 .status');
            let progress = 0;
            const interval = setInterval(() => {
                progress += Math.floor(Math.random() * 15) + 5;
                if (progress >= 100) {
                    progress = 100;
                    statusSpan.textContent = '[COMPLETE]';
                    clearInterval(interval);
                } else {
                    statusSpan.textContent = '[' + progress + '%]';
                }
            }, 100);
        }

        function resetVaultTransition() {
            // Reset all classes for next unlock
            document.getElementById('vaultWheelLeft').classList.remove('spinning');
            document.getElementById('vaultWheelRight').classList.remove('spinning');
            document.getElementById('vaultLockLeft').classList.remove('visible');
            document.getElementById('vaultLockRight').classList.remove('visible');
            document.getElementById('vaultStatus').classList.remove('show', 'granted');
            document.getElementById('boltTopLeft').classList.remove('unlocked');
            document.getElementById('boltTopRight').classList.remove('unlocked');
            document.getElementById('boltRightLeft').classList.remove('unlocked');
            document.getElementById('boltRightRight').classList.remove('unlocked');
            document.getElementById('boltBottomLeft').classList.remove('unlocked');
            document.getElementById('boltBottomRight').classList.remove('unlocked');
            document.getElementById('boltLeftLeft').classList.remove('unlocked');
            document.getElementById('boltLeftRight').classList.remove('unlocked');

            for (let i = 1; i <= 5; i++) {
                const el = document.getElementById('decrypt' + i);
                el.classList.remove('active', 'complete');
                el.style.color = '';
                el.style.textShadow = '';
            }
            document.querySelector('#decrypt2 .status').textContent = '';
        }

        async function lockSystem() {
            // Clear sensitive data from memory
            cachedCryptoKey = null;
            cachedSalt = null;
            data = createEmptyData();

            // Clear all rendered data from DOM
            document.getElementById('assetsBody').innerHTML = '';
            document.getElementById('futureAssetsBody').innerHTML = '';
            document.getElementById('incomeBody').innerHTML = '';
            document.getElementById('expensesBody').innerHTML = '';
            document.getElementById('totalNetWorth').textContent = '$0.00';
            document.getElementById('futureNetWorth').textContent = '$0.00';
            document.getElementById('yearlyPreTax').textContent = '$0.00';
            document.getElementById('yearlyPostTax').textContent = '$0.00';
            document.getElementById('totalExpenses').textContent = '$0.00';
            document.getElementById('yearlyRemaining').textContent = '$0.00';
            document.getElementById('monthlyLeftover').textContent = '$0.00';
            document.getElementById('progressSegments').innerHTML = '';
            document.getElementById('progressPercent').textContent = '0%';

            isLocked = true;
            isDemoMode = false;
            isFirstTimeSetup = false; // Never show setup mode after initial setup
            updateLockScreenMode();
            stopPriceAutoRefresh();

            const lockScreen = document.getElementById('lockScreen');
            lockScreen.classList.remove('hidden');
            document.getElementById('passwordInput').focus();
            clearTimeout(lockTimer);
        }

        function resetLockTimer() {
            clearTimeout(lockTimer);
            if (!isLocked) {
                lockTimer = setTimeout(lockSystem, LOCK_TIMEOUT);
            }
        }

        // Reset timer on activity
        ['mousemove', 'mousedown', 'click', 'keypress', 'keydown', 'touchstart', 'scroll'].forEach(event => {
            document.addEventListener(event, () => {
                if (!isLocked) resetLockTimer();
            });
        });


        // Password input handler
        document.addEventListener('DOMContentLoaded', () => {
            checkFirstTimeSetup();

            const input = document.getElementById('passwordInput');
            const confirmInput = document.getElementById('passwordConfirm');

            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    if (isFirstTimeSetup && !confirmInput.value) {
                        // If confirm field is empty, focus it
                        confirmInput.focus();
                    } else {
                        attemptUnlock();
                    }
                }
            });

            confirmInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    attemptUnlock();
                }
            });

            input.focus();
        });

        // =====================
        // CONSTANTS
        // =====================
        
        const FIREWORKS_THRESHOLD = 10000000;

        // =====================
        // DATA STRUCTURES
        // =====================

        const ASSET_TYPES = ['Crypto', 'Stocks', 'Low Risk Yield', 'Cash', 'Receivables', 'Private Fund', 'Property'];

        // Demo mode data - ~$2M portfolio (shows ~20% progress toward $10M goal)
        const DEMO_DATA = {
            assets: [
                // Stocks (~$700k)
                { name: 'AAPL', units: 1200, price: 185.50, type: 'Stocks', isCrypto: false },
                { name: 'NVDA', units: 350, price: 480.25, type: 'Stocks', isCrypto: false },
                { name: 'MSFT', units: 400, price: 378.90, type: 'Stocks', isCrypto: false },
                { name: 'GOOGL', units: 500, price: 142.50, type: 'Stocks', isCrypto: false },
                // Crypto (~$350k)
                { name: 'BTC', units: 3.2, price: 67500, type: 'Crypto', isCrypto: true, cryptoSymbol: 'BTC' },
                { name: 'ETH', units: 28, price: 3450, type: 'Crypto', isCrypto: true, cryptoSymbol: 'ETH' },
                { name: 'SOL', units: 520, price: 145, type: 'Crypto', isCrypto: true, cryptoSymbol: 'SOL' },
                // Low Risk Yield (~$300k)
                { name: 'Treasury Bills', units: 200000, price: 1, type: 'Low Risk Yield', isCrypto: false },
                { name: 'High Yield Savings', units: 100000, price: 1, type: 'Low Risk Yield', isCrypto: false },
                // Property (~$450k equity)
                { name: 'Primary Residence', units: 1, price: 350000, type: 'Property', isCrypto: false },
                { name: 'Rental Property', units: 1, price: 100000, type: 'Property', isCrypto: false },
                // Cash (~$75k)
                { name: 'Checking', units: 45000, price: 1, type: 'Cash', isCrypto: false },
                { name: 'Emergency Fund', units: 30000, price: 1, type: 'Cash', isCrypto: false },
            ],
            futureAssets: [
                // Stock vesting
                { name: 'AAPL RSU Vest', amount: 200, price: 185.50, isCrypto: false },
                { name: 'NVDA RSU Vest', amount: 80, price: 480.25, isCrypto: false },
                { name: 'Company Options', amount: 5000, price: 12.50, isCrypto: false },
            ],
            income: [
                { name: 'Software Engineer Salary', base: 285000, rate: 1, linkedType: null, linkedAsset: null },
                { name: 'Rental Income', base: 24000, rate: 1, linkedType: null, linkedAsset: null },
                { name: 'Dividend Income', base: 12000, rate: 1, linkedType: null, linkedAsset: null },
                { name: 'Staking Rewards', base: 0, rate: 0.05, linkedType: 'Crypto', linkedAsset: null },
                { name: 'High Yield Interest', base: 0, rate: 0.045, linkedType: null, linkedAsset: 'High Yield Savings' },
            ],
            expenses: [
                { name: 'Mortgage', yearly: 42000 },
                { name: 'Food & Dining', yearly: 14400 },
                { name: 'Utilities', yearly: 6000 },
                { name: 'Transportation', yearly: 7200 },
                { name: 'Insurance', yearly: 9600 },
                { name: 'Entertainment', yearly: 6000 },
                { name: 'Subscriptions', yearly: 2400 },
                { name: 'Travel', yearly: 12000 },
            ],
            assetTypes: [...ASSET_TYPES],
            settings: { taxRate: 35 }
        };

        let isDemoMode = false;

        async function runDemo() {
            const passwordInput = document.getElementById('passwordInput');
            const error = document.getElementById('lockError');

            // Clear any existing values
            passwordInput.value = '';
            error.textContent = '';

            // Type password animation
            for (let i = 0; i < 8; i++) {
                await new Promise(r => setTimeout(r, 80 + Math.random() * 60));
                passwordInput.value += '•';
            }

            // Brief pause then show verifying (like normal login)
            await new Promise(r => setTimeout(r, 300));
            error.textContent = 'VERIFYING...';
            passwordInput.disabled = true;

            // Pause to show verifying state
            await new Promise(r => setTimeout(r, 800));

            // Set demo mode and trigger unlock sequence
            isDemoMode = true;
            isFirstTimeSetup = false;
            isLocked = false;
            passwordInput.value = '';
            error.textContent = '';
            passwordInput.disabled = false;

            // Use existing vault transition
            startVaultTransition();
        }

        function createEmptyData() {
            return {
                assets: [],
                futureAssets: [],
                income: [],
                expenses: [],
                assetTypes: [...ASSET_TYPES],
                settings: { taxRate: 37 }
            };
        }

        let data = loadData();

        // =====================
        // LOCAL STORAGE
        // =====================

        function loadData() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                // If encrypted, return empty data - will be decrypted after unlock
                if (saved.startsWith(ENCRYPTED_MARKER)) {
                    return createEmptyData();
                }

                try {
                    const parsed = JSON.parse(saved);
                    let needsSave = false;
                    // Migrate shares -> units
                    if (parsed.assets) {
                        parsed.assets.forEach(asset => {
                            if (asset.shares !== undefined && asset.units === undefined) {
                                asset.units = asset.shares;
                                delete asset.shares;
                                needsSave = true;
                            }
                        });
                    }
                    if (needsSave) {
                        localStorage.setItem(STORAGE_KEY, JSON.stringify(parsed));
                    }
                    return parsed;
                } catch (e) {
                    console.error('Failed to parse stored data:', e);
                    return createEmptyData();
                }
            }
            return createEmptyData();
        }

        async function saveDataEncrypted() {
            if (cachedCryptoKey) {
                const encrypted = await encryptWithCachedKey(JSON.stringify(data));
                localStorage.setItem(STORAGE_KEY, encrypted);
            }
        }

        function saveData() {
            // Always save encrypted if we have a key
            if (cachedCryptoKey) {
                saveDataEncrypted(); // Fire and forget - async but we don't wait
            }
            // If no key (shouldn't happen while unlocked), don't save
        }

        function saveSettings() {
            data.settings.taxRate = parseFloat(document.getElementById('taxRate').value) || 37;
            saveData();
        }

        // =====================
        // CALCULATIONS
        // =====================

        function calculateAssetValue(asset) {
            return asset.units * asset.price;
        }

        function calculateTotalAssets() {
            return data.assets.reduce((sum, a) => sum + calculateAssetValue(a), 0);
        }

        function calculateFutureTotal() {
            return data.futureAssets.reduce((sum, a) => sum + (a.amount * a.price), 0);
        }

        function calculateTypeBreakdown() {
            const breakdown = {};
            data.assetTypes.forEach(type => breakdown[type] = 0);
            
            data.assets.forEach(asset => {
                const value = calculateAssetValue(asset);
                if (breakdown[asset.type] !== undefined) {
                    breakdown[asset.type] += value;
                }
            });
            
            return breakdown;
        }

        function getIncomeBase(inc) {
            // If linked to an asset type, sum all assets of that type
            if (inc.linkedType) {
                return data.assets
                    .filter(a => a.type === inc.linkedType)
                    .reduce((sum, a) => sum + calculateAssetValue(a), 0);
            }
            // If linked to a specific asset, use that asset's value
            if (inc.linkedAsset) {
                const asset = data.assets.find(a => a.name === inc.linkedAsset);
                return asset ? calculateAssetValue(asset) : 0;
            }
            // Otherwise use the fixed base
            return inc.base || 0;
        }

        function calculateYearlyIncome() {
            return data.income.reduce((sum, inc) => {
                const base = getIncomeBase(inc);
                if (inc.rate > 0) {
                    return sum + (base * inc.rate);
                }
                return sum + base;
            }, 0);
        }

        function calculateTotalExpenses() {
            return data.expenses.reduce((sum, exp) => sum + exp.yearly, 0);
        }

        // =====================
        // RENDERING
        // =====================

        function formatCurrency(num) {
            return '$' + num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function formatCompact(num) {
            if (num >= 1000000) return '$' + (num / 1000000).toFixed(2) + 'M';
            if (num >= 1000) return '$' + (num / 1000).toFixed(1) + 'K';
            return '$' + num.toFixed(0);
        }

        function formatPercent(num) {
            return num.toFixed(2) + '%';
        }

        function renderAssets() {
            const tbody = document.getElementById('assetsBody');

            if (isDecrypting) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center"><span class="loading">DECRYPTING DATA...</span></td></tr>';
                return;
            }

            if (!data.assets || data.assets.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--text-dim)">NO DATA</td></tr>';
                return;
            }

            const total = calculateTotalAssets();

            // Create array with original indices and sort by type
            const sortedAssets = data.assets
                .map((asset, i) => ({ asset, originalIndex: i }))
                .sort((a, b) => {
                    const typeOrder = data.assetTypes.indexOf(a.asset.type) - data.assetTypes.indexOf(b.asset.type);
                    if (typeOrder !== 0) return typeOrder;
                    // Within same type, sort by value descending
                    return calculateAssetValue(b.asset) - calculateAssetValue(a.asset);
                });
            
            tbody.innerHTML = sortedAssets.map(({ asset, originalIndex }) => {
                const value = calculateAssetValue(asset);
                const percent = total > 0 ? (value / total * 100) : 0;
                const showLoading = isPricesLoading && asset.isCrypto;

                return `
                    <tr>
                        <td>
                            <input type="text" value="${asset.name}"
                                onchange="updateAsset(${originalIndex}, 'name', this.value)"
                                ${asset.isCrypto ? 'style="color: var(--gold)"' : ''}>
                        </td>
                        <td>
                            <span class="select-placeholder" data-index="${originalIndex}" data-value="${asset.type}"></span>
                        </td>
                        <td>
                            <input type="number" value="${asset.units}" step="any"
                                onchange="updateAsset(${originalIndex}, 'units', parseFloat(this.value) || 0)">
                        </td>
                        <td>
                            ${showLoading
                                ? '<span class="loading" style="color: var(--gold)">...</span>'
                                : `<input type="number" value="${asset.price.toFixed(2)}" step="any"
                                    onchange="updateAsset(${originalIndex}, 'price', parseFloat(this.value) || 0)"
                                    ${asset.isCrypto ? 'style="color: var(--gold)"' : ''}>`
                            }
                        </td>
                        <td class="value-positive" style="text-align:right">${showLoading ? '<span class="loading">...</span>' : formatCurrency(value)}</td>
                        <td class="value-percent" style="text-align:right">${showLoading ? '<span class="loading">...</span>' : formatPercent(percent)}</td>
                        <td>
                            <button class="btn btn-danger" onclick="removeAsset(${originalIndex})">×</button>
                        </td>
                    </tr>
                `;
            }).join('');

            // Replace placeholders with custom selects
            tbody.querySelectorAll('.select-placeholder').forEach(placeholder => {
                const index = parseInt(placeholder.dataset.index);
                const currentValue = placeholder.dataset.value;
                const select = createCustomSelect(data.assetTypes, currentValue, (newValue) => {
                    updateAsset(index, 'type', newValue);
                });
                placeholder.replaceWith(select);
            });
        }

        function renderEnergyTanks() {
            const container = document.getElementById('energyTanks');
            const breakdown = calculateTypeBreakdown();
            const total = calculateTotalAssets();

            if (total === 0) {
                container.innerHTML = '<div style="text-align:center;color:var(--text-dim);padding:20px">NO DATA</div>';
                return;
            }

            const colorMap = {
                'Crypto': 'energy-crypto',
                'Stocks': 'energy-stocks',
                'Low Risk Yield': 'energy-lowrisk',
                'Cash': 'energy-cash',
                'Receivables': 'energy-receivables',
                'Private Fund': 'energy-privatefund',
                'Property': 'energy-property'
            };

            container.innerHTML = Object.entries(breakdown)
                .filter(([_, value]) => value > 0)
                .sort((a, b) => b[1] - a[1])
                .map(([type, value]) => {
                    const percent = total > 0 ? (value / total * 100) : 0;
                    const colorClass = colorMap[type] || 'energy-crypto';
                    
                    return `
                        <div class="energy-bar">
                            <div class="energy-label">
                                <span class="name">${type}</span>
                                <span>
                                    <span class="value">${formatCurrency(value)}</span>
                                    <span class="percent">${formatPercent(percent)}</span>
                                </span>
                            </div>
                            <div class="energy-track">
                                <div class="energy-fill ${colorClass}" style="width: ${percent}%"></div>
                            </div>
                        </div>
                    `;
                }).join('');
        }

        function renderFutureAssets() {
            const tbody = document.getElementById('futureBody');

            if (isDecrypting) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center"><span class="loading">DECRYPTING DATA...</span></td></tr>';
                return;
            }

            if (!data.futureAssets || data.futureAssets.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--text-dim)">NO DATA</td></tr>';
                return;
            }

            tbody.innerHTML = data.futureAssets.map((asset, i) => {
                const value = asset.amount * asset.price;
                const showLoading = isPricesLoading && asset.isCrypto;
                
                return `
                    <tr>
                        <td>
                            <input type="text" value="${asset.name}" 
                                onchange="updateFutureAsset(${i}, 'name', this.value)"
                                style="color: var(--sol-cyan)">
                        </td>
                        <td>
                            <input type="number" value="${asset.amount}" step="any"
                                onchange="updateFutureAsset(${i}, 'amount', parseFloat(this.value) || 0)">
                        </td>
                        <td>
                            ${showLoading 
                                ? '<span class="loading" style="color: var(--gold)">...</span>'
                                : `<input type="number" value="${asset.price.toFixed(2)}" step="any"
                                    onchange="updateFutureAsset(${i}, 'price', parseFloat(this.value) || 0)"
                                    style="color: var(--gold)">`
                            }
                        </td>
                        <td class="value-positive" style="text-align:right">${showLoading ? '<span class="loading">...</span>' : formatCurrency(value)}</td>
                        <td>
                            <button class="btn btn-danger" onclick="removeFutureAsset(${i})">×</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderIncome() {
            const tbody = document.getElementById('incomeBody');

            if (isDecrypting) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center"><span class="loading">DECRYPTING DATA...</span></td></tr>';
                return;
            }

            if (!data.income || data.income.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--text-dim)">NO DATA</td></tr>';
                return;
            }

            tbody.innerHTML = data.income.map((inc, i) => {
                const base = getIncomeBase(inc);
                const yearly = inc.rate > 0 ? base * inc.rate : base;
                const isLinked = inc.linkedType || inc.linkedAsset;
                const linkLabel = inc.linkedType ? `← ${inc.linkedType}` : (inc.linkedAsset ? `← ${inc.linkedAsset}` : '');
                
                // Check if linked to a crypto asset
                const linkedToCrypto = inc.linkedAsset && data.assets.find(a => a.name === inc.linkedAsset && a.isCrypto);
                const showLoading = isPricesLoading && linkedToCrypto;
                
                return `
                    <tr>
                        <td>
                            <input type="text" value="${inc.name}" 
                                onchange="updateIncome(${i}, 'name', this.value)">
                        </td>
                        <td style="text-align:right">
                            ${showLoading 
                                ? '<span class="loading" style="color: var(--text-dim)">...</span>'
                                : (isLinked 
                                    ? `<span style="color: var(--text-dim)">${formatCurrency(base)}</span><br><span style="font-size:6px;color:var(--sol-cyan)">${linkLabel}</span>`
                                    : `<input type="number" value="${base.toFixed(2)}" step="any" onchange="updateIncome(${i}, 'base', parseFloat(this.value) || 0)">`)
                            }
                        </td>
                        <td>
                            <input type="number" value="${(inc.rate * 100).toFixed(2)}" step="any"
                                onchange="updateIncome(${i}, 'rate', (parseFloat(this.value) || 0) / 100)"
                                style="color: var(--sol-cyan)">
                        </td>
                        <td class="value-positive" style="text-align:right">${showLoading ? '<span class="loading">...</span>' : formatCurrency(yearly)}</td>
                        <td>
                            <button class="btn btn-danger" onclick="removeIncome(${i})">×</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderExpenses() {
            const tbody = document.getElementById('expenseBody');

            if (isDecrypting) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center"><span class="loading">DECRYPTING DATA...</span></td></tr>';
                return;
            }

            if (!data.expenses || data.expenses.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;color:var(--text-dim)">NO DATA</td></tr>';
                return;
            }

            tbody.innerHTML = data.expenses.map((exp, i) => {
                return `
                    <tr>
                        <td>
                            <input type="text" value="${exp.name}" 
                                onchange="updateExpense(${i}, 'name', this.value)">
                        </td>
                        <td>
                            <input type="number" value="${exp.yearly.toFixed(2)}" step="any"
                                onchange="updateExpense(${i}, 'yearly', parseFloat(this.value) || 0)"
                                style="color: var(--warning-red)">
                        </td>
                        <td>
                            <button class="btn btn-danger" onclick="removeExpense(${i})">×</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderAssetTypes() {
            const container = document.getElementById('typesList');
            container.innerHTML = data.assetTypes.map(type => 
                `<span class="type-tag">${type}<span class="remove" onclick="removeAssetType('${type}')">×</span></span>`
            ).join('');
        }

        function renderSummary() {
            if (isDecrypting) {
                document.getElementById('totalNetWorth').innerHTML = '<span class="loading">DECRYPTING...</span>';
                document.getElementById('futureNetWorth').innerHTML = '<span class="loading">DECRYPTING...</span>';
                document.getElementById('yearlyPreTax').innerHTML = '<span class="loading">...</span>';
                document.getElementById('yearlyPostTax').innerHTML = '<span class="loading">...</span>';
                document.getElementById('totalExpenses').innerHTML = '<span class="loading">...</span>';
                document.getElementById('yearlyRemaining').innerHTML = '<span class="loading">...</span>';
                document.getElementById('monthlyLeftover').innerHTML = '<span class="loading">...</span>';
                return;
            }
            if (isPricesLoading) {
                document.getElementById('totalNetWorth').innerHTML = '<span class="loading">SYNCING...</span>';
                document.getElementById('futureNetWorth').innerHTML = '<span class="loading">SYNCING...</span>';
                document.getElementById('yearlyPreTax').innerHTML = '<span class="loading">...</span>';
                document.getElementById('monthlyLeftover').innerHTML = '<span class="loading">...</span>';
                return;
            }
            
            const total = calculateTotalAssets();
            const futureValue = calculateFutureTotal();
            const yearlyIncome = calculateYearlyIncome();
            const taxRate = data.settings.taxRate / 100;
            const yearlyPostTax = yearlyIncome * (1 - taxRate);
            const totalExpenses = calculateTotalExpenses();
            const yearlyRemaining = yearlyPostTax - totalExpenses;
            const monthlyLeftover = yearlyRemaining / 12;

            document.getElementById('totalNetWorth').textContent = formatCurrency(total);
            document.getElementById('futureNetWorth').textContent = formatCurrency(total + futureValue);
            document.getElementById('yearlyPreTax').textContent = formatCurrency(yearlyIncome);
            document.getElementById('yearlyPostTax').textContent = formatCurrency(yearlyPostTax);
            document.getElementById('totalExpenses').textContent = formatCurrency(totalExpenses);
            document.getElementById('yearlyRemaining').textContent = formatCurrency(yearlyRemaining);
            document.getElementById('monthlyLeftover').textContent = formatCurrency(monthlyLeftover);
            
            // Update progress bar
            renderProgressBar(total);
            
            checkFireworks(total);
        }

        function renderProgressBar(total) {
            const target = FIREWORKS_THRESHOLD;
            const percent = Math.min(100, (total / target) * 100);
            const segmentCount = 20;
            const filledSegments = Math.floor((percent / 100) * segmentCount);
            
            document.getElementById('progressPercent').textContent = percent.toFixed(1) + '%';
            
            const container = document.getElementById('progressSegments');
            container.innerHTML = '';
            
            // Gradient from purple to cyan to green
            const gradientColors = [
                '#9945FF', '#9945FF', '#9945FF', '#9945FF', '#9945FF',
                '#7B5FFF', '#5D79FF', '#3F93FF', '#21ADFF', '#00D1FF',
                '#00D9E0', '#00E1C1', '#00E9A2', '#07F183', '#14F195',
                '#14F195', '#14F195', '#14F195', '#14F195', '#14F195'
            ];
            
            for (let i = 0; i < segmentCount; i++) {
                const segment = document.createElement('div');
                segment.className = 'progress-segment';
                
                if (i < filledSegments) {
                    segment.classList.add('filled');
                    segment.style.background = gradientColors[i];
                    segment.style.boxShadow = `0 0 8px ${gradientColors[i]}`;
                }
                
                container.appendChild(segment);
            }
        }

        // =====================
        // PIXELATED PIE CHARTS
        // =====================

        const CHART_COLORS = [
            '#9945FF', // purple
            '#14F195', // green
            '#FF6B6B', // coral red
            '#00D1FF', // cyan
            '#FFD93D', // yellow
            '#FF8C42', // orange
            '#6BCB77', // sage
            '#4D96FF', // blue
            '#C9B1FF', // lavender
            '#FF6BD6', // pink
        ];

        function drawPixelatedPie(canvasId, legendId, dataItems, labelKey, valueKey) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            const legend = document.getElementById(legendId);
            
            // Clear
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Filter out zero values
            const filtered = dataItems.filter(item => item[valueKey] > 0);
            const total = filtered.reduce((sum, item) => sum + item[valueKey], 0);
            
            if (total === 0 || filtered.length === 0) {
                ctx.fillStyle = '#2a2a4a';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                legend.innerHTML = '<div style="color: var(--text-dim)">NO DATA</div>';
                return;
            }
            
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = Math.min(centerX, centerY) - 10;
            const pixelSize = 4; // Size of each "pixel" block
            
            // Build angle ranges for each slice
            let currentAngle = -Math.PI / 2; // Start at top
            const slices = filtered.map((item, i) => {
                const sliceAngle = (item[valueKey] / total) * Math.PI * 2;
                const slice = {
                    startAngle: currentAngle,
                    endAngle: currentAngle + sliceAngle,
                    color: CHART_COLORS[i % CHART_COLORS.length],
                    label: item[labelKey],
                    value: item[valueKey],
                    percent: (item[valueKey] / total * 100).toFixed(1)
                };
                currentAngle += sliceAngle;
                return slice;
            });
            
            // Draw pixelated pie
            for (let x = 0; x < canvas.width; x += pixelSize) {
                for (let y = 0; y < canvas.height; y += pixelSize) {
                    const dx = x + pixelSize/2 - centerX;
                    const dy = y + pixelSize/2 - centerY;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance <= radius) {
                        let angle = Math.atan2(dy, dx);
                        // Normalize angle to match our starting point
                        if (angle < -Math.PI / 2) angle += Math.PI * 2;
                        
                        // Find which slice this pixel belongs to
                        for (const slice of slices) {
                            let start = slice.startAngle;
                            let end = slice.endAngle;
                            
                            // Handle angle wrapping
                            if (end > Math.PI * 1.5) {
                                if (angle >= start || angle <= end - Math.PI * 2) {
                                    ctx.fillStyle = slice.color;
                                    ctx.fillRect(x, y, pixelSize - 1, pixelSize - 1);
                                    break;
                                }
                            } else if (angle >= start && angle < end) {
                                ctx.fillStyle = slice.color;
                                ctx.fillRect(x, y, pixelSize - 1, pixelSize - 1);
                                break;
                            }
                        }
                    }
                }
            }
            
            // Draw pixelated border
            ctx.strokeStyle = '#2a2a4a';
            ctx.lineWidth = 2;
            for (let angle = 0; angle < Math.PI * 2; angle += 0.1) {
                const x = centerX + Math.cos(angle) * (radius + 2);
                const y = centerY + Math.sin(angle) * (radius + 2);
                ctx.fillStyle = '#1a1a2e';
                ctx.fillRect(Math.floor(x / pixelSize) * pixelSize, Math.floor(y / pixelSize) * pixelSize, pixelSize, pixelSize);
            }
            
            // Render legend
            legend.innerHTML = slices.map(slice => `
                <div class="legend-item">
                    <div class="legend-color" style="background: ${slice.color}"></div>
                    <span class="legend-text">${slice.label}</span>
                    <span class="legend-value">${formatCompact(slice.value)} (${slice.percent}%)</span>
                </div>
            `).join('');
        }

        function renderCharts() {
            // Inventory - individual assets
            const assetData = data.assets
                .map(a => ({ name: a.name, value: calculateAssetValue(a) }))
                .filter(a => a.value > 0)
                .sort((a, b) => b.value - a.value);
            drawPixelatedPie('chartInventory', 'legendInventory', assetData, 'name', 'value');
            
            // Energy Allocation - by type
            const breakdown = calculateTypeBreakdown();
            const typeData = Object.entries(breakdown)
                .map(([type, value]) => ({ name: type, value }))
                .filter(t => t.value > 0)
                .sort((a, b) => b.value - a.value);
            drawPixelatedPie('chartEnergy', 'legendEnergy', typeData, 'name', 'value');
            
            // Supply Lines - income sources
            const incomeData = data.income
                .map(inc => ({ name: inc.name, value: inc.rate > 0 ? getIncomeBase(inc) * inc.rate : getIncomeBase(inc) }))
                .filter(i => i.value > 0)
                .sort((a, b) => b.value - a.value);
            drawPixelatedPie('chartSupply', 'legendSupply', incomeData, 'name', 'value');
        }

        // =====================
        // PIXEL FIREWORKS
        // =====================

        let fireworksTriggered = false;
        let lastNetWorth = 0;

        function launchFireworks() {
            const canvas = document.getElementById('fireworksCanvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            const particles = [];
            const pixelSize = 4;
            const colors = ['#9945FF', '#14F195', '#00D1FF', '#FF6B6B', '#FFD93D', '#FF8C42'];
            
            class Particle {
                constructor(x, y, color, velocity) {
                    this.x = x;
                    this.y = y;
                    this.color = color;
                    this.velocity = velocity;
                    this.alpha = 1;
                    this.decay = 0.015 + Math.random() * 0.015;
                    this.gravity = 0.12;
                }
                
                update() {
                    this.velocity.y += this.gravity;
                    this.x += this.velocity.x;
                    this.y += this.velocity.y;
                    this.alpha -= this.decay;
                }
                
                draw() {
                    ctx.globalAlpha = this.alpha;
                    ctx.fillStyle = this.color;
                    const px = Math.floor(this.x / pixelSize) * pixelSize;
                    const py = Math.floor(this.y / pixelSize) * pixelSize;
                    ctx.fillRect(px, py, pixelSize, pixelSize);
                }
            }
            
            function createExplosion(x, y) {
                const particleCount = 50 + Math.random() * 30;
                const color = colors[Math.floor(Math.random() * colors.length)];

                for (let i = 0; i < particleCount; i++) {
                    const angle = (Math.PI * 2 / particleCount) * i;
                    const speed = 2 + Math.random() * 4;
                    particles.push(new Particle(
                        x, y, color,
                        { x: Math.cos(angle) * speed, y: Math.sin(angle) * speed }
                    ));
                }
            }
            
            let explosionCount = 0;
            const maxExplosions = 15;
            
            function scheduleExplosion() {
                if (explosionCount < maxExplosions) {
                    const x = Math.random() * canvas.width;
                    const y = Math.random() * (canvas.height * 0.6);
                    createExplosion(x, y);
                    explosionCount++;
                    setTimeout(scheduleExplosion, 200 + Math.random() * 400);
                }
            }
            
            scheduleExplosion();
            
            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                for (let i = particles.length - 1; i >= 0; i--) {
                    particles[i].update();
                    particles[i].draw();
                    
                    if (particles[i].alpha <= 0) {
                        particles.splice(i, 1);
                    }
                }
                
                ctx.globalAlpha = 1;
                
                if (particles.length > 0 || explosionCount < maxExplosions) {
                    requestAnimationFrame(animate);
                } else {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                }
            }
            
            animate();
        }

        function illuminateProgressBar() {
            const segments = document.querySelectorAll('.progress-segment.filled');
            const totalDuration = 4500; // Match fireworks duration
            const delayPerSegment = totalDuration / segments.length;
            
            segments.forEach((segment, i) => {
                // Light up
                setTimeout(() => {
                    segment.classList.add('illuminate');
                }, i * delayPerSegment);
                
                // Fade out
                setTimeout(() => {
                    segment.classList.remove('illuminate');
                }, i * delayPerSegment + 300);
            });
            
            // Second wave
            setTimeout(() => {
                segments.forEach((segment, i) => {
                    setTimeout(() => {
                        segment.classList.add('illuminate');
                    }, i * (delayPerSegment * 0.7));
                    
                    setTimeout(() => {
                        segment.classList.remove('illuminate');
                    }, i * (delayPerSegment * 0.7) + 300);
                });
            }, totalDuration * 0.6);
        }

        function launchCelebration() {
            launchFireworks();
            illuminateProgressBar();
            showCelebrationOverlay();
        }

        function showCelebrationOverlay() {
            const overlay = document.getElementById('celebrationOverlay');
            overlay.classList.remove('hidden');
            
            // Hide after fireworks end
            setTimeout(() => {
                overlay.classList.add('hidden');
            }, 6000);
        }

        function checkFireworks(total) {
            // Trigger when crossing threshold upward
            if (total >= FIREWORKS_THRESHOLD && lastNetWorth < FIREWORKS_THRESHOLD && !fireworksTriggered) {
                fireworksTriggered = true;
                launchCelebration();
            }
            // Reset if we drop below so it can trigger again
            if (total < FIREWORKS_THRESHOLD) {
                fireworksTriggered = false;
            }
            lastNetWorth = total;
        }

        function recalculate() {
            renderAssets();
            renderEnergyTanks();
            renderFutureAssets();
            renderIncome();
            renderExpenses();
            renderAssetTypes();
            renderSummary();
            renderCharts();
        }

        // =====================
        // CRUD OPERATIONS
        // =====================

        function updateAsset(index, field, value) {
            data.assets[index][field] = value;
            saveData();
            recalculate();
        }

        function addAsset() {
            data.assets.push({
                name: 'New Asset',
                units: 0,
                price: 0,
                type: data.assetTypes[0] || 'Crypto',
                isCrypto: false,
                cryptoSymbol: ''
            });
            saveData();
            recalculate();
        }

        function removeAsset(index) {
            data.assets.splice(index, 1);
            saveData();
            recalculate();
        }

        function updateFutureAsset(index, field, value) {
            data.futureAssets[index][field] = value;
            saveData();
            recalculate();
        }

        function addFutureAsset() {
            data.futureAssets.push({
                name: 'New Vesting',
                amount: 0,
                price: 0,
                isCrypto: false,
                cryptoSymbol: ''
            });
            saveData();
            recalculate();
        }

        function removeFutureAsset(index) {
            data.futureAssets.splice(index, 1);
            saveData();
            recalculate();
        }

        function updateIncome(index, field, value) {
            data.income[index][field] = value;
            saveData();
            recalculate();
        }

        function addIncome() {
            data.income.push({
                name: 'New Income',
                base: 0,
                rate: 0,
                linkedType: '',
                linkedAsset: ''
            });
            saveData();
            recalculate();
        }

        function removeIncome(index) {
            data.income.splice(index, 1);
            saveData();
            recalculate();
        }

        function updateExpense(index, field, value) {
            data.expenses[index][field] = value;
            saveData();
            recalculate();
        }

        function addExpense() {
            data.expenses.push({
                name: 'New Expense',
                yearly: 0
            });
            saveData();
            recalculate();
        }

        function removeExpense(index) {
            data.expenses.splice(index, 1);
            saveData();
            recalculate();
        }

        function addAssetType() {
            const input = document.getElementById('newTypeInput');
            const type = input.value.trim();
            if (type && !data.assetTypes.includes(type)) {
                data.assetTypes.push(type);
                saveData();
                recalculate();
            }
            input.value = '';
        }

        function removeAssetType(type) {
            const index = data.assetTypes.indexOf(type);
            if (index > -1) {
                data.assetTypes.splice(index, 1);
                saveData();
                recalculate();
            }
        }

        // =====================
        // CRYPTO PRICE REFRESH
        // =====================

        async function refreshPrices() {
            const btn = document.getElementById('refreshBtn');
            const status = document.getElementById('refreshStatus');
            
            if (btn.disabled) return;
            
            btn.disabled = true;
            btn.innerHTML = '<span class="loading">LOADING...</span>';
            status.textContent = '';
            status.className = 'refresh-status';
            
            // Show loading state
            isPricesLoading = true;
            recalculate();

            try {
                // Using CoinGecko API
                const res = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=solana,bitcoin&vs_currencies=usd');
                
                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}`);
                }
                
                const priceData = await res.json();
                
                if (!priceData.solana || !priceData.bitcoin) {
                    throw new Error('Invalid response');
                }

                const solPrice = priceData.solana.usd;
                const btcPrice = priceData.bitcoin.usd;

                // Update assets with SOL price
                data.assets.forEach(asset => {
                    if (asset.cryptoSymbol === 'SOL') {
                        asset.price = solPrice;
                    } else if (asset.cryptoSymbol === 'BTC') {
                        asset.price = btcPrice;
                    }
                });

                // Update future assets
                data.futureAssets.forEach(asset => {
                    if (asset.cryptoSymbol === 'SOL' || asset.name.toUpperCase() === 'SOL') {
                        asset.price = solPrice;
                    } else if (asset.cryptoSymbol === 'BTC') {
                        asset.price = btcPrice;
                    }
                });

                saveData();
                isPricesLoading = false;
                recalculate();

                status.textContent = `SOL: $${solPrice.toFixed(2)} | BTC: $${btcPrice.toFixed(2)}`;
                status.className = 'refresh-status success';
            } catch (error) {
                console.error('Price fetch error:', error);
                isPricesLoading = false;
                recalculate();
                status.textContent = 'FETCH ERROR';
                status.className = 'refresh-status error';
            }

            // 5 second cooldown to prevent rate limiting
            btn.innerHTML = 'WAIT 5s...';
            setTimeout(() => {
                btn.disabled = false;
                btn.innerHTML = 'REFRESH PRICES';
            }, 5000);
        }

        // Auto-refresh prices every 1 minute
        let priceRefreshInterval = null;

        function startPriceAutoRefresh() {
            if (priceRefreshInterval) return;
            // Refresh immediately on unlock
            refreshPrices();
            // Then every 60 seconds
            priceRefreshInterval = setInterval(() => {
                if (!isLocked) {
                    refreshPrices();
                }
            }, 60000);
        }

        function stopPriceAutoRefresh() {
            if (priceRefreshInterval) {
                clearInterval(priceRefreshInterval);
                priceRefreshInterval = null;
            }
        }

        // =====================
        // IMPORT/EXPORT
        // =====================

        let resetConfirmStep = 0;

        function clearAllData() {
            if (isLocked) return;
            resetConfirmStep = 0;
            updateResetModal();
            document.getElementById('resetModal').classList.remove('hidden');
        }

        function cancelReset() {
            resetConfirmStep = 0;
            document.getElementById('resetModal').classList.add('hidden');
        }

        function updateResetModal() {
            const subtitle = document.getElementById('resetSubtitle');
            const warning = document.getElementById('resetWarning');
            const btn = document.getElementById('resetConfirmBtn');

            if (resetConfirmStep === 0) {
                subtitle.textContent = 'THIS WILL DELETE ALL ENCRYPTED DATA';
                warning.textContent = 'MAKE SURE YOU HAVE EXPORTED YOUR DATA FIRST';
                btn.textContent = 'CONFIRM RESET';
            } else {
                subtitle.textContent = 'ARE YOU ABSOLUTELY SURE?';
                warning.textContent = 'THIS CANNOT BE UNDONE';
                btn.textContent = 'DELETE EVERYTHING';
            }
        }

        function confirmReset() {
            if (resetConfirmStep === 0) {
                resetConfirmStep = 1;
                updateResetModal();
            } else {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        }

        function exportData() {
            if (isLocked) return;
            // Export the encrypted data from localStorage
            const encrypted = localStorage.getItem(STORAGE_KEY);
            if (!encrypted) {
                showNotify('No data to export', 'EXPORT ERROR');
                return;
            }
            const blob = new Blob([encrypted], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'null-sector-backup.enc';
            a.click();
            URL.revokeObjectURL(url);
        }

        let pendingBackupContent = null;

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            event.target.value = ''; // Reset file input

            const reader = new FileReader();
            reader.onload = (e) => {
                const content = e.target.result;

                // Check if it's encrypted
                if (content.startsWith(ENCRYPTED_MARKER)) {
                    // Store content and show modal
                    pendingBackupContent = content;
                    document.getElementById('backupModal').classList.remove('hidden');
                    document.getElementById('backupPasswordInput').value = '';
                    document.getElementById('backupError').classList.add('hidden');
                    document.getElementById('backupPasswordInput').focus();
                } else {
                    // Try parsing as plaintext JSON (legacy format)
                    try {
                        const imported = JSON.parse(content);
                        if (!isLocked) {
                            data = imported;
                            saveData();
                            document.getElementById('taxRate').value = data.settings.taxRate;
                            recalculate();
                            showNotify('Data imported successfully', 'IMPORT COMPLETE');
                        } else {
                            showNotify('Please unlock your vault first to import plaintext data', 'ACCESS DENIED');
                        }
                    } catch (error) {
                        showNotify('Invalid file format', 'IMPORT ERROR');
                    }
                }
            };
            reader.readAsText(file);
        }

        function cancelBackupRestore() {
            pendingBackupContent = null;
            document.getElementById('backupModal').classList.add('hidden');
            document.getElementById('backupPasswordInput').value = '';
        }

        async function confirmBackupRestore() {
            const password = document.getElementById('backupPasswordInput').value;
            if (!password || !pendingBackupContent) return;

            try {
                const result = await decryptData(pendingBackupContent, password);
                const imported = JSON.parse(result.data);

                if (isLocked && isFirstTimeSetup) {
                    // First-time setup: use backup password as vault password
                    data = imported;
                    const salt = crypto.getRandomValues(new Uint8Array(16));
                    cachedCryptoKey = await deriveKey(password, salt);
                    cachedSalt = salt;
                    await saveDataEncrypted();
                    isFirstTimeSetup = false;
                    isLocked = false;
                    document.getElementById('lockScreen').classList.add('hidden');
                    document.getElementById('backupModal').classList.add('hidden');
                    document.getElementById('taxRate').value = data.settings.taxRate;
                    recalculate();
                    resetLockTimer();
                    startPriceAutoRefresh();
                } else if (!isLocked) {
                    // Already logged in: re-encrypt with current password
                    data = imported;
                    saveData();
                    document.getElementById('backupModal').classList.add('hidden');
                    document.getElementById('taxRate').value = data.settings.taxRate;
                    recalculate();
                } else {
                    // Locked with existing vault - need to unlock first
                    showNotify('Please unlock your vault first, or reset it to import this backup', 'ACCESS DENIED');
                    cancelBackupRestore();
                }
                pendingBackupContent = null;
            } catch (error) {
                document.getElementById('backupError').classList.remove('hidden');
                document.getElementById('backupPasswordInput').value = '';
                document.getElementById('backupPasswordInput').focus();
            }
        }

        // =====================
        // INIT
        // =====================

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('taxRate').value = data.settings.taxRate;
            // Initialize lastNetWorth to prevent fireworks on page load
            lastNetWorth = calculateTotalAssets();
            recalculate();
        });

        // Cheat code: press 'f' for celebration, 'l' to lock, Shift+D for debug
        document.addEventListener('keydown', (e) => {
            if (e.key === 'f' && document.activeElement.tagName !== 'INPUT') {
                launchCelebration();
            }
            if ((e.key === 'l' || e.key === ' ') && document.activeElement.tagName !== 'INPUT' && !isLocked) {
                e.preventDefault();
                lockSystem();
            }
            if (e.key === 'D' && e.shiftKey) {
                e.preventDefault();
                showDebugModal();
            }
            if (e.key === 'Escape' || e.key === 'Enter') {
                const notifyModal = document.getElementById('notifyModal');
                if (!notifyModal.classList.contains('hidden')) {
                    closeNotify();
                    return;
                }
            }
            if (e.key === 'Escape') {
                // Close any open dropdowns first
                const openDropdowns = document.querySelectorAll('.custom-select.open');
                if (openDropdowns.length > 0) {
                    openDropdowns.forEach(d => d.classList.remove('open'));
                    return;
                }
                const resetModal = document.getElementById('resetModal');
                if (!resetModal.classList.contains('hidden')) {
                    cancelReset();
                    return;
                }
                const backupModal = document.getElementById('backupModal');
                if (!backupModal.classList.contains('hidden')) {
                    cancelBackupRestore();
                    return;
                }
                const debugModal = document.getElementById('debugModal');
                if (!debugModal.classList.contains('hidden')) {
                    closeDebugModal();
                    return;
                }
                const fullscreenPanel = document.querySelector('.panel.fullscreen');
                if (fullscreenPanel) {
                    fullscreenPanel.classList.remove('fullscreen');
                    document.body.style.overflow = '';
                }
            }
            if (e.key === 'Enter' && document.activeElement.id === 'backupPasswordInput') {
                e.preventDefault();
                confirmBackupRestore();
            }
        });

        function showDebugModal() {
            const modal = document.getElementById('debugModal');
            const statusEl = document.getElementById('debugStatus');
            const dataEl = document.getElementById('debugData');

            const stored = localStorage.getItem(STORAGE_KEY);
            const encrypted = stored && stored.startsWith(ENCRYPTED_MARKER);

            // Show status
            statusEl.innerHTML = `
                <div class="debug-status-item">
                    <span class="debug-status-label">STORAGE STATUS: </span>
                    <span class="${encrypted ? 'debug-status-encrypted' : 'debug-status-decrypted'}">
                        ${encrypted ? 'ENCRYPTED' : 'DECRYPTED (PLAINTEXT)'}
                    </span>
                </div>
                <div class="debug-status-item">
                    <span class="debug-status-label">LOCK STATE: </span>
                    <span class="debug-status-value">${isLocked ? 'LOCKED' : 'UNLOCKED'}</span>
                </div>
                <div class="debug-status-item">
                    <span class="debug-status-label">CRYPTO KEY IN MEMORY: </span>
                    <span class="debug-status-value">${cachedCryptoKey ? 'YES' : 'NO'}</span>
                </div>
                <div class="debug-status-item">
                    <span class="debug-status-label">DATA SIZE: </span>
                    <span class="debug-status-value">${stored ? stored.length.toLocaleString() : 0} bytes</span>
                </div>
            `;

            // Show raw localStorage data
            let output = '=== localStorage (always encrypted) ===\n';
            output += stored || '(no data)';

            // Show in-memory data if unlocked
            if (cachedCryptoKey && !isLocked) {
                output += '\n\n=== In-Memory Data (decrypted) ===\n';
                output += JSON.stringify(data, null, 2);
            } else {
                output += '\n\n=== In-Memory Data ===\n';
                output += '(locked - no access to decrypted data)';
            }

            dataEl.textContent = output;

            modal.classList.remove('hidden');
        }

        function closeDebugModal() {
            document.getElementById('debugModal').classList.add('hidden');
        }

        function showNotify(message, title = 'NOTICE') {
            document.getElementById('notifyTitle').textContent = title;
            document.getElementById('notifyMessage').textContent = message;
            document.getElementById('notifyModal').classList.remove('hidden');
        }

        function closeNotify() {
            document.getElementById('notifyModal').classList.add('hidden');
        }

        // =====================
        // CUSTOM DROPDOWN
        // =====================

        function createCustomSelect(options, selectedValue, onChangeCallback) {
            const wrapper = document.createElement('div');
            wrapper.className = 'custom-select';

            const trigger = document.createElement('div');
            trigger.className = 'custom-select-trigger';
            trigger.textContent = selectedValue || 'Select...';

            const optionsContainer = document.createElement('div');
            optionsContainer.className = 'custom-select-options';

            options.forEach(opt => {
                const option = document.createElement('div');
                option.className = 'custom-select-option' + (opt === selectedValue ? ' selected' : '');
                option.textContent = opt;
                option.onclick = (e) => {
                    e.stopPropagation();
                    trigger.textContent = opt;
                    optionsContainer.querySelectorAll('.custom-select-option').forEach(o => o.classList.remove('selected'));
                    option.classList.add('selected');
                    wrapper.classList.remove('open');
                    onChangeCallback(opt);
                };
                optionsContainer.appendChild(option);
            });

            trigger.onclick = (e) => {
                e.stopPropagation();
                // Close all other dropdowns
                document.querySelectorAll('.custom-select.open').forEach(s => {
                    if (s !== wrapper) s.classList.remove('open');
                });
                wrapper.classList.toggle('open');
            };

            wrapper.appendChild(trigger);
            wrapper.appendChild(optionsContainer);

            return wrapper;
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.custom-select')) {
                document.querySelectorAll('.custom-select.open').forEach(s => s.classList.remove('open'));
            }
        });

        function toggleFullscreen(event) {
            // Don't toggle if clicking inside inputs, buttons, select, or custom dropdowns
            if (['INPUT', 'BUTTON', 'SELECT'].includes(event.target.tagName)) return;
            if (event.target.closest('.custom-select')) return;

            const panel = event.currentTarget;
            panel.classList.toggle('fullscreen');

            if (panel.classList.contains('fullscreen')) {
                document.body.style.overflow = 'hidden';
            } else {
                document.body.style.overflow = '';
            }
        }
    </script>
</body>
</html>
